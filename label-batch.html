<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RP LABELBATCH V3.3</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-app: #0d1117;       
            --bg-panel: #161b22;     
            --bg-header: #21262d;    
            --bg-input: #010409;     
            --text-main: #c9d1d9;    
            --text-muted: #8b949e;   
            --accent-green: #10b981; 
            --accent-blue: #58a6ff;
            --border-color: #30363d; 
            --radius-sm: 4px; 
        }

        body { font-family: 'Inter', sans-serif; background-color: var(--bg-app); color: var(--text-main); padding: 40px; max-width: 1400px; margin: 0 auto; }
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid var(--border-color); padding-bottom: 20px; }
        
        h1 { font-family: "Segoe UI Variable Display", sans-serif; font-weight: 400; font-size: 1.8rem; letter-spacing: 4px; text-transform: uppercase; margin: 0; display: flex; align-items: center; gap: 15px; color: #fff; }
        h1::before { content: ""; display: block; width: 6px; height: 28px; background: var(--accent-green); }

        .search-container { margin-bottom: 25px; position: relative; }
        .search-bar { width: 100%; background: var(--bg-panel); border: 1px solid var(--border-color); color: #fff; padding: 12px 15px; border-radius: var(--radius-sm); font-size: 0.95rem; outline: none; box-sizing: border-box; }
        .search-bar:focus { border-color: var(--accent-blue); }

        .btn-group { display: flex; gap: 8px; }
        .btn-data { background: var(--bg-panel); border: 1px solid var(--accent-blue); color: var(--accent-blue); padding: 8px 16px; font-size: 0.85rem; font-weight: 700; cursor: pointer; border-radius: var(--radius-sm); display: flex; align-items: center; gap: 8px; }
        .btn-nav { background: transparent; border: 1px solid var(--border-color); color: var(--text-muted); padding: 8px 16px; font-size: 0.85rem; font-weight: 600; cursor: pointer; border-radius: var(--radius-sm); }
        .btn-new { color: var(--accent-green); border-color: var(--accent-green); }
        
        .global-actions { display: none; background: var(--bg-panel); border: 1px solid var(--border-color); padding: 15px 20px; margin-bottom: 30px; border-radius: var(--radius-sm); align-items: center; justify-content: space-between; }
        .btn-print-selected { background: var(--accent-green); color: #0d1117; font-weight: 700; padding: 10px 20px; border: none; border-radius: var(--radius-sm); cursor: pointer; text-transform: uppercase; }

        .upload-zone { background: var(--bg-panel); border: 1px dashed var(--border-color); padding: 40px; text-align: center; margin-bottom: 40px; cursor: pointer; border-radius: var(--radius-sm); }
        
        .isa-bundle { background: var(--bg-panel); border: 1px solid var(--border-color); margin-bottom: 15px; border-radius: var(--radius-sm); overflow: hidden; }
        .isa-bundle.selected { border-left: 4px solid var(--accent-green); }
        
        .isa-header { background: var(--bg-header); padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; }
        .header-main-area { display: flex; align-items: center; flex-grow: 1; cursor: pointer; }
        
        .isa-time-badge { color: var(--accent-green); font-size: 0.85rem; font-weight: 600; background: rgba(16, 185, 129, 0.15); padding: 4px 8px; border-radius: var(--radius-sm); margin-left: 10px; }
        .collapse-icon { transition: transform 0.2s; color: var(--text-muted); font-size: 0.8rem; margin-right: 12px; }
        .collapsed .collapse-icon { transform: rotate(-90deg); }
        .bundle-content { display: block; }
        .collapsed .bundle-content { display: none; }

        .dispatch-table { width: 100%; border-collapse: collapse; background: #0d1117; }
        .dispatch-table td { padding: 12px 20px; border-bottom: 1px solid var(--border-color); color: var(--text-main); vertical-align: middle; }
        
        .qty-input, .carrier-edit, .po-input { background: var(--bg-input); border: 1px solid var(--border-color); color: #fff; padding: 6px; border-radius: var(--radius-sm); outline: none; }
        .qty-input { width: 60px; text-align: center; font-weight: 700; }
        .po-input { color: var(--accent-blue); width: 120px; font-weight: 600; text-transform: uppercase; }
        
        .mode-toggle { display: flex; background: var(--bg-input); border: 1px solid var(--border-color); border-radius: var(--radius-sm); margin-left: 15px; }
        .mode-btn { border: none; padding: 6px 12px; cursor: pointer; font-size: 0.75rem; color: var(--text-muted); background: transparent; font-weight: 600; }
        .mode-btn.active { background: #262626; color: #fff; }

        .btn-printed { background: transparent !important; color: var(--accent-green) !important; border: 1px solid var(--accent-green) !important; font-weight: 800; }
        .row-printed { opacity: 0.5; }
        #fileStatus { font-size: 0.75rem; color: var(--text-muted); margin-bottom: 15px; text-align: right; }
    </style>
</head>
<body>

    <div class="top-bar">
        <h1>RP LABELBATCH</h1>
        <div class="btn-group">
            <button class="btn-nav btn-new" onclick="newFile()">NEW</button>
            <button class="btn-data" onclick="saveData()">SAVE</button>
            <button class="btn-nav" onclick="saveAsData()">SAVE AS</button>
            <label class="btn-data">LOAD <input type="file" id="jsonLoader" accept=".json" style="display:none" onchange="loadData(this)"></label>
        </div>
    </div>
    <div id="fileStatus">ACTIVE FILE: NONE</div>

    <div class="search-container">
        <input type="text" id="mainSearch" class="search-bar" placeholder="SEARCH APPOINTMENT ID, CARRIER, OR ISD..." oninput="handleSearch()">
    </div>

    <div id="globalActions" class="global-actions">
        <div>
            <button class="btn-nav" onclick="selectAll(true)">SELECT ALL</button>
            <button class="btn-nav" onclick="selectAll(false)">DESELECT ALL</button>
            <button class="btn-nav" onclick="expandAll(true)">EXPAND ALL</button>
            <button class="btn-nav" onclick="expandAll(false)">COLLAPSE ALL</button>
        </div>
        <button class="btn-print-selected" onclick="printSelectedBundles()">PRINT SELECTED BUNDLES</button>
    </div>

    <div class="upload-zone" id="uploadZone" onclick="document.getElementById('fileUpload').click()">
        <span id="uploadText">CLICK TO UPLOAD SCHEDULE (.XLSX / .CSV)</span>
        <input type="file" id="fileUpload" accept=".csv, .xlsx, .xls" style="display:none" onchange="handleFile(this)">
    </div>

    <div id="dashboardArea"></div>

    <script>
        /** * MODULAR ZPL ENGINE V3.3 - HIERARCHICAL DATE/TIME */
        const ZPL_TEMPLATES = {
            getHeader: (text, date, time) => {
                return `^XA^PW812^LL1200` + 
                    // Carrier Header (Largest)
                    `^FO0,40^FB812,2,10,C,0^A0N,100,100^FD${text.toUpperCase()}^FS` + 
                    // Date (Bigger)
                    `^FO0,150^FB812,1,0,C,0^A0N,90,90^FD${date}^FS` + 
                    // Time (Smaller in brackets)
                    `^FO0,240^FB812,1,0,C,0^A0N,50,50^FD(${time})^FS`;
            },
            
            individual: (header, date, time, id, po, current, total, isMaster) => {
                const title = isMaster ? "APPOINTMENT ID" : "SHIPMENT ID";
                const countDisplay = (current === 0) ? "0 / 1" : `${current} / ${total}`;
                
                // Adjusted coordinates (Y shifted down to prevent overlap with multi-line header)
                let zpl = ZPL_TEMPLATES.getHeader(header, date, time) + 
                    `^FO0,330^FB812,1,0,C,0^A0N,30,30^FD${title}^FS` + 
                    `^FO60,360^BY4,3,300^BCN,300,N,N,N^FD${id}^FS` + 
                    `^FO0,670^FB812,1,0,C,0^A0N,60,60^FD${id}^FS`;
                
                if(po && po.trim() !== "") { 
                    zpl += `^FO0,790^FB812,1,0,C,0^A0N,50,50^FDPO: ${po.toUpperCase()}^FS`; 
                }
                
                zpl += `^FO0,1020^FB812,1,0,C,0^A0N,150,150^FD${countDisplay}^FS^XZ`;
                return zpl;
            }
        };

        let ISA_GROUPS = {};
        let activeFileHandle = null;
        let searchQuery = "";

        window.addEventListener('keydown', function(e) {
            if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
                e.preventDefault();
                const sBar = document.getElementById('mainSearch');
                sBar.focus();
                sBar.select();
            }
        });

        function handleSearch() {
            searchQuery = document.getElementById('mainSearch').value.toLowerCase();
            renderDashboard();
        }

        function formatShortDate(raw) {
            if (typeof raw === 'number') { const d = new Date((raw - 25569) * 86400 * 1000); return d.getDate() + ["JAN","FEB","MAR","APR","MAY","JUN","JUL","AUG","SEP","OCT","NOV","DEC"][d.getMonth()]; }
            return String(raw);
        }

        function formatTime(rawTime) {
            if (!rawTime) return "";
            if (typeof rawTime === 'number') { 
                const totalSeconds = Math.round(rawTime * 86400); 
                const hours = Math.floor(totalSeconds / 3600); 
                const minutes = Math.floor((totalSeconds % 3600) / 60); 
                const ampm = hours >= 12 ? 'PM' : 'AM'; 
                const showHour = hours % 12 || 12; 
                const showMin = String(minutes).padStart(2, '0'); 
                return `${showHour}:${showMin} ${ampm}`; 
            }
            return String(rawTime);
        }

        function handleFile(input) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const rows = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], {header: 1});
                parseData(rows);
            };
            reader.readAsArrayBuffer(input.files[0]);
        }

        function parseData(rows) {
            ISA_GROUPS = {};
            for(let i=1; i<rows.length; i++) {
                const row = rows[i]; if(!row || !row[2]) continue;
                const id = String(row[2]).trim();
                if(!ISA_GROUPS[id]) { 
                    ISA_GROUPS[id] = { id, carrier: row[4] ? String(row[4]).toUpperCase() : "INBOUND", date: formatShortDate(row[0]), time: formatTime(row[1]), mode: 'expanded', selected: true, printed: false, collapsed: false, jobs: [] };
                }
                ISA_GROUPS[id].jobs.push({ isd: String(row[3]), qty: parseInt(row[6]) || 0, po: '', printed: false });
            }
            renderDashboard();
        }

        function renderDashboard() {
            const container = document.getElementById('dashboardArea'); container.innerHTML = "";
            const entries = Object.entries(ISA_GROUPS);
            if (entries.length > 0) document.getElementById('globalActions').style.display = 'flex';

            entries.forEach(([key, bundle]) => {
                const matchSearch = bundle.id.toLowerCase().includes(searchQuery) || bundle.carrier.toLowerCase().includes(searchQuery) || bundle.jobs.some(j => j.isd.toLowerCase().includes(searchQuery));
                if (searchQuery && !matchSearch) return;

                const card = document.createElement('div');
                card.className = `isa-bundle ${bundle.selected ? 'selected' : ''} ${bundle.collapsed ? 'collapsed' : ''}`;
                
                let rowsHtml = bundle.mode === 'expanded' ? 
                    bundle.jobs.map((j, idx) => `<tr class="${j.printed ? 'row-printed' : ''}"><td>ISD: <strong>${j.isd}</strong></td><td width="150"><input type="text" class="po-input" placeholder="PO#" value="${j.po}" onchange="updatePO('${key}', ${idx}, this.value)"></td><td width="100" align="center"><input type="number" class="qty-input" value="${j.qty}" onchange="updateQty('${key}', ${idx}, this.value)"></td><td width="120" align="right"><button class="btn-nav ${j.printed ? 'btn-printed' : ''}" onclick="printSingle('${key}', ${idx})">${j.printed ? 'PRINTED ✓' : 'PRINT'}</button></td></tr>`).join('') :
                    `<tr><td>MASTER: <strong>${bundle.id}</strong></td><td width="150"></td><td width="100" align="center"><input type="number" class="qty-input" value="${bundle.jobs.reduce((sum, j) => sum + j.qty, 0)}" readonly></td><td width="120" align="right"><button class="btn-nav ${bundle.printed ? 'btn-printed' : ''}" onclick="printBundle('${key}')">${bundle.printed ? 'PRINTED ✓' : 'PRINT'}</button></td></tr>`;

                card.innerHTML = `
                    <div class="isa-header">
                        <div class="header-main-area" onclick="toggleCollapse('${key}')">
                            <span class="collapse-icon">▼</span>
                            <strong>${bundle.id}</strong>
                            <span class="isa-time-badge">${bundle.time || "N/A"}</span>
                            <input type="text" class="carrier-edit" style="margin-left:15px;" value="${bundle.carrier}" onclick="event.stopPropagation()" onchange="updateCarrier('${key}', this.value)">
                            <div class="mode-toggle" onclick="event.stopPropagation()">
                                <button class="mode-btn ${bundle.mode==='expanded'?'active':''}" onclick="setMode('${key}','expanded')">ISD</button>
                                <button class="mode-btn ${bundle.mode==='condensed'?'active':''}" onclick="setMode('${key}','condensed')">ISA</button>
                            </div>
                        </div>
                        <div style="display:flex; align-items:center; gap:15px;">
                            <input type="checkbox" style="width:18px; height:18px;" ${bundle.selected ? 'checked' : ''} onchange="toggleSelect('${key}', this.checked)">
                            <button class="btn-nav ${bundle.printed ? 'btn-printed' : ''}" onclick="printBundle('${key}')">${bundle.printed ? 'ISA PRINTED ✓' : 'PRINT ISA'}</button>
                        </div>
                    </div>
                    <div class="bundle-content">
                        <table class="dispatch-table"><tbody>${rowsHtml}</tbody></table>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function toggleCollapse(id) { ISA_GROUPS[id].collapsed = !ISA_GROUPS[id].collapsed; renderDashboard(); }
        function expandAll(val) { Object.keys(ISA_GROUPS).forEach(k => ISA_GROUPS[k].collapsed = !val); renderDashboard(); }
        function toggleSelect(id, val) { ISA_GROUPS[id].selected = val; renderDashboard(); }
        function setMode(id, mode) { ISA_GROUPS[id].mode = mode; renderDashboard(); }
        function updateCarrier(id, val) { ISA_GROUPS[id].carrier = val; }
        function updatePO(id, idx, val) { ISA_GROUPS[id].jobs[idx].po = val; }
        function updateQty(id, idx, val) { ISA_GROUPS[id].jobs[idx].qty = parseInt(val) || 0; renderDashboard(); }
        function selectAll(val) { Object.keys(ISA_GROUPS).forEach(k => ISA_GROUPS[k].selected = val); renderDashboard(); }

        function printSingle(id, idx) {
            const b = ISA_GROUPS[id]; const job = b.jobs[idx]; const labels = [];
            if(job.qty === 0) labels.push(ZPL_TEMPLATES.individual(b.carrier, b.date, b.time, job.isd, job.po, 0, 1, false));
            else { for(let i=1; i<=job.qty; i++) labels.push(ZPL_TEMPLATES.individual(b.carrier, b.date, b.time, job.isd, job.po, i, job.qty, false)); }
            job.printed = true; renderDashboard(); launchPrinter(labels);
        }

        function printBundle(id) {
            const b = ISA_GROUPS[id]; const labels = [];
            if(b.mode === 'expanded') {
                b.jobs.forEach(job => {
                    if(job.qty === 0) labels.push(ZPL_TEMPLATES.individual(b.carrier, b.date, b.time, job.isd, job.po, 0, 1, false));
                    else { for(let i=1; i<=job.qty; i++) labels.push(ZPL_TEMPLATES.individual(b.carrier, b.date, b.time, job.isd, job.po, i, job.qty, false)); }
                    job.printed = true;
                });
            } else {
                const total = b.jobs.reduce((sum, j) => sum + j.qty, 0);
                for(let i=1; i<=total; i++) labels.push(ZPL_TEMPLATES.individual(b.carrier, b.date, b.time, b.id, "", i, total, true));
                b.jobs.filter(j => j.qty === 0).forEach(j => labels.push(ZPL_TEMPLATES.individual(b.carrier, b.date, b.time, j.isd, j.po, 0, 1, false)));
            }
            b.printed = true; b.selected = false; b.collapsed = true; renderDashboard(); launchPrinter(labels);
        }

        function printSelectedBundles() {
            let list = [];
            Object.keys(ISA_GROUPS).filter(k => ISA_GROUPS[k].selected).forEach(id => {
                const b = ISA_GROUPS[id];
                if(b.mode === 'expanded') {
                    b.jobs.forEach(j => {
                        if(j.qty === 0) list.push(ZPL_TEMPLATES.individual(b.carrier, b.date, b.time, j.isd, j.po, 0, 1, false));
                        else { for(let i=1; i<=j.qty; i++) list.push(ZPL_TEMPLATES.individual(b.carrier, b.date, b.time, j.isd, j.po, i, j.qty, false)); }
                        j.printed = true;
                    });
                } else {
                    const total = b.jobs.reduce((sum, j) => sum + j.qty, 0);
                    for(let i=1; i<=total; i++) list.push(ZPL_TEMPLATES.individual(b.carrier, b.date, b.time, b.id, "", i, total, true));
                    b.jobs.filter(j => j.qty === 0).forEach(j => list.push(ZPL_TEMPLATES.individual(b.carrier, b.date, b.time, j.isd, j.po, 0, 1, false)));
                }
                b.printed = true; b.selected = false; b.collapsed = true;
            });
            renderDashboard(); launchPrinter(list);
        }

        function launchPrinter(zplArray) {
            const urls = zplArray.map(z => `https://api.labelary.com/v1/printers/8dpmm/labels/4x6/0/${encodeURIComponent(z)}`);
            const pWin = window.open('', '_blank', 'width=600,height=800');
            pWin.document.write(`<html><head><style>@page { size: 101.6mm 152.4mm; margin: 0; } body { margin: 0; padding: 0; background: #000; color: #0f0; font-family: monospace; text-align: center; } .status { padding: 20px; font-size: 1.2rem; } img { width: 101.6mm; height: 152.4mm; display: block; page-break-after: always; } @media print { .status { display: none !important; } }</style></head><body><div id="status" class="status">RENDERING...</div><div id="labels"></div><script>const urls = ${JSON.stringify(urls)}; function loadNext(i) { if (i >= urls.length) { document.getElementById('status').innerText = "READY"; setTimeout(() => { window.print(); window.close(); }, 500); return; } document.getElementById('status').innerText = "LABEL " + (i + 1) + " / " + urls.length; const img = document.createElement('img'); img.src = urls[i]; img.onload = () => { document.getElementById('labels').appendChild(img); loadNext(i + 1); }; } loadNext(0); <\/script></body></html>`);
            pWin.document.close();
        }

        function newFile() {
            if(Object.keys(ISA_GROUPS).length > 0 && !confirm("Reset tool?")) return;
            ISA_GROUPS = {}; activeFileHandle = null; document.getElementById('fileStatus').innerText = "ACTIVE FILE: NONE";
            document.getElementById('dashboardArea').innerHTML = ""; document.getElementById('globalActions').style.display = 'none';
        }

        async function saveData() {
            if (Object.keys(ISA_GROUPS).length === 0) return;
            if (!activeFileHandle) return saveAsData();
            try { const writable = await activeFileHandle.createWritable(); await writable.write(JSON.stringify(ISA_GROUPS, null, 2)); await writable.close(); alert("Saved Changes."); } catch (err) { saveAsData(); }
        }

        async function saveAsData() {
            const options = { suggestedName: `BATCH_${new Date().toLocaleDateString('en-GB').split('/').reverse().join('.')}.json`, types: [{ description: 'JSON', accept: {'application/json': ['.json']} }] };
            try { activeFileHandle = await window.showSaveFilePicker(options); document.getElementById('fileStatus').innerText = "ACTIVE FILE: " + activeFileHandle.name; saveData(); } catch (err) {}
        }

        function loadData(input) {
            const reader = new FileReader(); reader.onload = (e) => { ISA_GROUPS = JSON.parse(e.target.result); renderDashboard(); };
            reader.readAsText(input.files[0]);
        }
    </script>
</body>
</html>