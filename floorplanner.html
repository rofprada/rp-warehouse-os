<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RP FLOORPLANNER V5.2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-app: #0d1117; --bg-panel: #161b22; --text-main: #c9d1d9; 
            --accent-green: #10b981; --accent-blue: #58a6ff; --accent-cyan: #00f2ff; --accent-red: #f85149; 
            --unit-size: 60px;
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-app); color: var(--text-main); margin: 0; overflow: hidden; height: 100vh; }
        
        .top-bar { display: flex; justify-content: space-between; align-items: center; padding: 0 40px; border-bottom: 1px solid #30363d; background: var(--bg-app); height: 70px; z-index: 2000; position: relative; }
        h1 { font-weight: 900; letter-spacing: 2px; text-transform: uppercase; color: #fff; font-size: 0.9rem; }
        .btn-nav { background: transparent; border: 1px solid #30363d; color: #8b949e; padding: 6px 14px; font-size: 0.7rem; font-weight: 900; cursor: pointer; border-radius: 4px; }
        .btn-active { background: var(--accent-blue) !important; color: #000 !important; border: none !important; }

        #warehouse-viewport { height: calc(100vh - 70px); overflow: auto; background: #000; position: relative; }
        #viewport-content { width: fit-content; margin: 0 auto; display: block; position: relative; }
        #coord-header { display: flex; position: sticky; top: 0; z-index: 1000; background: var(--bg-app); border-bottom: 1px solid #30363d; width: 720px; }
        .col-label { width: var(--unit-size); height: 30px; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 900; color: #8b949e; }
        #warehouse-stage { position: relative; width: fit-content; display: flex; }
        #grid-canvas { display: grid; grid-template-columns: repeat(12, var(--unit-size)); width: 720px; background: #000; position: relative; z-index: 10; }
        .grid-unit { width: var(--unit-size); height: var(--unit-size); border: 0.5px solid rgba(255,255,255,0.05); box-sizing: border-box; }
        .grid-unit[id*="-1-"], .grid-unit[id*="-2-"] { background: rgba(248, 81, 73, 0.04); }

        #row-labels { width: 40px; position: sticky; right: 0; z-index: 1000; background: var(--bg-app); border-left: 1px solid #30363d; }
        .row-label { height: var(--unit-size); display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 900; color: #8b949e; }

        #pallet-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 500; }
        .pallet-block { position: absolute; pointer-events: auto; z-index: 600; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; width: 118px; height: 118px; border: 2.5px solid rgba(0,0,0,0.8); border-radius: 4px; box-sizing: border-box; padding-top: 32px; overflow: hidden; }
        .occupied { background: var(--accent-green); color: #000; }
        .high-stack { background: var(--accent-blue); color: #000; }
        .is-selected { box-shadow: 0 0 15px var(--accent-cyan) !important; border: 2.5px solid var(--accent-cyan) !important; z-index: 800 !important; }
        
        .handle-tray { position: absolute; top: 4px; left: 4px; z-index: 700; display: flex; gap: 4px; }
        .h-btn { width: 22px; height: 22px; background: rgba(0,0,0,0.75); border-radius: 3px; display: flex; align-items: center; justify-content: center; cursor: pointer; border: 1px solid rgba(255,255,255,0.2); }
        
        .p-carrier { font-weight: 900; text-align: center; width: 90%; padding: 0 4px; text-transform: uppercase; line-height: 1; margin-bottom: 2px; pointer-events: none; white-space: nowrap; overflow: visible; }
        .p-qty { font-size: 10px; font-weight: 900; line-height: 1; margin: 2px 0; pointer-events: none; opacity: 0.9; }
        .p-date { font-size: 9px; font-weight: 800; background: rgba(0,0,0,0.1); padding: 1px 6px; border-radius: 2px; margin-top: auto; margin-bottom: 6px; pointer-events: none; opacity: 0.7; }

        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 3000; align-items: center; justify-content: center; backdrop-filter: blur(10px); }
        .modal.active { display: flex; }
        .modal-content { background: var(--bg-panel); border: 1px solid #30363d; width: 440px; padding: 30px; border-radius: 12px; }
        .mode-btn { flex: 1; padding: 14px 4px; font-size: 10px; font-weight: 900; text-transform: uppercase; border: 1px solid #30363d; border-radius: 6px; color: #8b949e; cursor: pointer; }
        .mode-btn.active { background: var(--accent-blue) !important; color: #000 !important; border: none !important; }

        /* [Other Styles Preserved] */
        .audit-grid { display: grid; grid-template-columns: 80px 250px 1fr 100px 100px 150px; align-items: center; border-bottom: 1px solid #30363d; }
        .audit-header { background: #21262d; position: sticky; top: 0; z-index: 100; padding: 12px 0; font-size: 11px; font-weight: 900; color: #9ca3af; text-transform: uppercase; letter-spacing: 0.05em; }
        .isa-row { background: #161b22; padding: 10px 0; }
        .isd-row { padding: 8px 0; font-size: 13px; border-bottom: 1px solid #161b22; }
        .live-input { background: rgba(0,0,0,0.4); border: 1px solid #30363d; color: var(--accent-blue); font-weight: 900; font-size: 13px; text-transform: uppercase; width: 95%; padding: 8px; border-radius: 4px; }
        .btn-toggle { width: 34px; height: 34px; background: var(--accent-blue); color: #000; font-weight: 900; border-radius: 6px; cursor: pointer; margin-left: 20px; }
        .btn-detach { color: var(--accent-red); font-size: 11px; font-weight: 400; border: 1px solid rgba(248, 81, 73, 0.3); padding: 5px 12px; border-radius: 4px; cursor: pointer; text-transform: uppercase; }
    </style>
</head>
<body onload="init()">
    <div class="top-bar">
        <h1>RP FLOORPLANNER V5.2</h1>
        <div class="flex gap-2">
            <button onclick="switchView('grid')" id="btn-grid" class="btn-nav btn-active">GRID VIEW</button>
            <button onclick="switchView('manifest')" id="btn-manifest" class="btn-nav">AUDIT</button>
            <button onclick="switchView('settings')" id="btn-settings" class="btn-nav">DATA HUB</button>
            <button class="btn-nav" onclick="window.location.href='index.html'" style="color:var(--accent-blue)">HUB</button>
        </div>
    </div>

    <div id="view-grid" class="section-view">
        <div id="warehouse-viewport">
            <div id="viewport-content">
                <div id="coord-header"></div>
                <div id="warehouse-stage">
                    <div id="grid-canvas"></div>
                    <div id="pallet-layer"></div>
                    <div id="row-labels"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="view-manifest" class="p-8 section-view" style="display: none;">
        <div class="max-w-[1400px] mx-auto bg-[#161b22] border border-[#30363d] rounded-lg h-[80vh] flex flex-col overflow-hidden">
            <div class="p-6 bg-[#0d1117] border-b border-[#30363d] flex justify-between items-center">
                <h3 class="text-sm font-black uppercase text-white">Modular Manifest Viewer</h3>
                <input type="text" id="mSearch" class="bg-black border border-[#30363d] p-3 text-xs w-80 rounded" placeholder="Filter carrier..." oninput="renderAudit()">
            </div>
            <div class="audit-grid audit-header"><div class="text-center">+/-</div><div class="px-2">Carrier</div><div class="px-4">Reference ID</div><div class="text-center">Total PLT</div><div class="text-center">Units</div><div class="text-center">Action</div></div>
            <div id="auditList" class="overflow-y-scroll flex-1"></div>
        </div>
    </div>

    <div id="view-settings" class="p-10 section-view" style="display: none;">
        <div class="max-w-4xl mx-auto text-center">
            <div class="grid grid-cols-2 gap-8 mb-10">
                <div class="bg-panel border border-[#30363d] p-10 rounded-2xl"><h3 class="text-xs font-black uppercase mb-4 text-[#58a6ff]">Restore Session</h3><input type="file" id="jsonIn" onchange="handleRestore(this)" class="hidden"><button onclick="document.getElementById('jsonIn').click()" class="w-full py-4 border border-[#30363d] font-black rounded text-accent-blue uppercase">Load JSON</button></div>
                <div class="bg-panel border border-[#30363d] p-10 rounded-2xl"><h3 class="text-xs font-black uppercase mb-4 text-[#10b981]">Load Manifest</h3><input type="file" id="csvIn" onchange="handleCSV(this)" class="hidden"><button onclick="document.getElementById('csvIn').click()" class="w-full py-4 border border-[#30363d] font-black rounded text-accent-green uppercase">Load CSV</button></div>
            </div>
            <div class="flex flex-col items-center gap-4 bg-red-900/10 border border-red-500/20 p-10 rounded-2xl">
                <button onclick="clearGrid()" class="w-64 py-4 border border-red-500 text-red-500 font-black rounded text-xs uppercase">Vacate Grid</button>
                <button onclick="clearManifest()" class="w-64 py-4 border border-red-500 text-red-500 font-black rounded text-xs uppercase">Reset Manifest</button>
            </div>
        </div>
    </div>

    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <h3 id="modal-title" class="text-xl font-black mb-4 uppercase text-white">Layout Engine</h3>
            <div id="picker-area" class="mb-4" style="display:none;"><label class="text-[10px] font-black text-orange-500 uppercase">Load from manifest</label><select id="shipment-picker" onchange="applyPicker()" class="w-full bg-black text-white p-3 border border-gray-700 rounded mt-1"></select></div>
            <div class="flex gap-2 mb-6">
                <button id="mode-compact" onclick="setOpMode('compact')" class="mode-btn active">Compact</button>
                <button id="mode-buffer" onclick="setOpMode('buffer')" class="mode-btn">Buffer</button>
                <button id="mode-breakdown" onclick="setOpMode('breakdown')" class="mode-btn">Breakdown</button>
            </div>
            <div class="space-y-4">
                <div class="grid grid-cols-2 gap-2">
                    <div><label class="text-[10px] font-black text-gray-500 uppercase">Qty</label><input type="number" id="in-qty" class="w-full bg-black border border-gray-700 p-3 rounded text-white" value="1"></div>
                    <div><label class="text-[10px] font-black text-gray-500 uppercase">Carrier</label><input type="text" id="in-carrier" class="w-full bg-black border border-gray-700 p-3 rounded text-white"></div>
                </div>
                <div><label class="text-[10px] font-black text-gray-500 uppercase">Reference ID</label><input type="text" id="in-id" class="w-full bg-black border border-gray-700 p-3 rounded text-white"></div>
            </div>
            <div class="flex gap-2 mt-8">
                <button onclick="commitPlacement()" class="flex-1 py-4 bg-accent-green text-black font-black rounded uppercase text-xs" id="btn-drop">Drop Formation</button>
                <button onclick="reLayoutCurrentGroup()" class="flex-1 py-4 bg-accent-cyan text-black font-black rounded uppercase text-xs" id="btn-relayout" style="display:none">Update Mode</button>
                <button onclick="delPallet()" id="btn-del" class="flex-1 py-4 bg-accent-red text-white font-black rounded uppercase text-xs">Delete</button>
                <button onclick="closeModal()" class="flex-1 py-4 border border-[#30363d] font-bold rounded uppercase text-xs">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        let warehouseData = { pallets: [] }, GROUPS = {}; 
        let opMode = 'compact', activeLoc = null, editIdx = null;
        let moveState = { active: false, selectedIndices: [], startR: 0, startC: 0, targetR: 0, targetC: 0 };
        const ROWS = 140, COLS = 12, UNIT = 60, COL_NAMES = ["L", "K", "J", "I", "H", "G", "F", "E", "D", "C", "B", "A"];

        function init() { load(); buildGrid(); render(); }
        function load() { const s = localStorage.getItem('rp_v52'); if(s) warehouseData = JSON.parse(s); }
        function save() { localStorage.setItem('rp_v52', JSON.stringify(warehouseData)); }

        function buildGrid() {
            const h = document.getElementById('coord-header'), r = document.getElementById('row-labels'), c = document.getElementById('grid-canvas');
            h.innerHTML = ''; r.innerHTML = ''; c.innerHTML = '';
            COL_NAMES.forEach(n => h.innerHTML += `<div class="col-label">${n}</div>`);
            for(let i=1; i<=ROWS; i++) r.innerHTML += `<div class="row-label">${i}</div>`;
            for(let i=0; i<ROWS*COLS; i++) {
                const row = Math.floor(i/COLS)+1, col = (i%COLS)+1;
                const u = document.createElement('div'); u.className = 'grid-unit'; u.id = `unit-${row}-${col}`;
                u.onclick = () => handleGridClick(row, col);
                u.onmouseenter = () => { if(moveState.active) { moveState.targetR = row; moveState.targetC = col; updateGhosts(row, col); } };
                c.appendChild(u);
            }
        }

        function render() {
            const layer = document.getElementById('pallet-layer'); layer.innerHTML = '';
            warehouseData.pallets.forEach((p, idx) => {
                const isS = moveState.selectedIndices.includes(idx);
                const groupPallets = warehouseData.pallets.filter(item => item.id === p.id);
                const sequenceNum = groupPallets.indexOf(p) + 1;
                const totalInGroup = GROUPS[p.id] ? GROUPS[p.id].total : groupPallets.length;
                const cName = p.carrier || 'MANUAL';
                let fs = 22, ls = -1.5;
                if (cName.length > 7) { fs = Math.max(12, 22 - (cName.length - 7) * 1.2); ls = Math.max(-2, -1.5 - (cName.length - 7) * 0.1); }
                const b = document.createElement('div');
                b.className = `pallet-block ${p.qty > 1 ? 'high-stack' : 'occupied'} ${isS ? 'is-selected' : ''}`;
                b.id = `plt-${idx}`; b.style.left = `${(p.c-1) * UNIT + 1}px`; b.style.top = `${(p.r-1) * UNIT + 1}px`;
                b.innerHTML = `
                    <div class="handle-tray">
                        <div class="h-btn" onmousedown="startDrag(event, ${idx})"><svg width="14" height="14" fill="white" viewBox="0 0 24 24"><path d="M10 9h4V6h3l-5-5-5 5h3v3zm-1 1H6V7l-5 5 5 5v-3h3v-4zm14 2l-5-5v3h-3v4h3v3l5-5zm-9 3h-4v3H7l5 5 5-5h-3v-3z"/></svg></div>
                        <div class="h-btn" onclick="event.stopPropagation(); selGroup('${p.id}')"><svg width="14" height="14" fill="white" viewBox="0 0 24 24"><path d="M3.9 12c.5-1.7 2-3 3.9-3h4V7H7.8c-3 0-5.4 2.1-5.9 4.9.4-.2.9-.3 1.4-.3.2 0 .5 0 .6.1zM16.2 15c-.5 1.7-2 3-3.9 3h-4v2h4.2c3 0 5.4-2.1 5.9-4.9-.4.2-.9.3-1.4.3-.2 0-.5 0-.6-.1zM13 11H7v2h6v-2zM21.2 11c-.5-1.7-2-3-3.9-3h-4v2h4.2c2 0 3.7 1.3 4.2 3.1.4-.2.9-.3 1.4-.3.2 0 .5 0 .6.1.1-1-.2-1.9-.5-2.9z"/></svg></div>
                        <div class="h-btn" onclick="event.stopPropagation(); toggleSel(${idx})"><svg width="14" height="14" fill="white" viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg></div>
                    </div>
                    <div class="p-carrier" style="font-size: ${fs}px; letter-spacing: ${ls}px">${cName}</div>
                    <div class="p-qty">${sequenceNum}/${totalInGroup}</div>
                    <div class="p-date">${p.date || 'N/A'}</div>`;
                b.onclick = (e) => { e.stopPropagation(); if(!moveState.active) openEdit(idx); };
                layer.appendChild(b);
            });
            if(document.getElementById('view-manifest').style.display !== 'none') renderAudit();
        }

        /* NEW FEATURE: DYNAMIC RE-LAYOUT LOGIC */
        function reLayoutCurrentGroup() {
            const p = warehouseData.pallets[editIdx];
            const groupId = p.id;
            const groupCarrier = p.carrier;
            const groupDate = p.date;
            const groupTotal = GROUPS[groupId].total;
            const startLoc = { r: p.r, c: p.c };

            // 1. Remove entire group from floor
            warehouseData.pallets = warehouseData.pallets.filter(item => item.id !== groupId);
            
            // 2. Re-staged with current opMode logic
            let droppedCount = 0, vStep = 2, validCols = [11, 9, 7, 5, 3];
            if(opMode === 'buffer' || opMode === 'breakdown') { vStep = (opMode === 'buffer') ? 3 : 6; validCols = [11, 8, 5, 2]; }
            
            let r = startLoc.r;
            while (droppedCount < groupTotal && r <= ROWS - 1) {
                for (let c of validCols) {
                    if (droppedCount >= groupTotal) break;
                    if (r === startLoc.r && c > startLoc.c) continue;
                    if (!isOcc(r, c)) { 
                        warehouseData.pallets.push({ r, c, qty: 1, carrier: groupCarrier, id: groupId, date: groupDate }); 
                        droppedCount++; 
                    }
                }
                r += vStep;
            }
            save(); closeModal(); render();
        }

        function renderAudit() {
            const list = document.getElementById('auditList'); if(!list) return;
            const search = document.getElementById('mSearch').value.toUpperCase();
            list.innerHTML = '';
            Object.keys(GROUPS).forEach(id => {
                if (search && !GROUPS[id].carrier.includes(search) && !id.includes(search)) return;
                const g = GROUPS[id], staged = warehouseData.pallets.filter(p => p.id === id).length;
                const div = document.createElement('div');
                div.innerHTML = `<div class="audit-grid isa-row"><div><button class="btn-toggle" onclick="toggleISA('${id}')">${g.open ? 'âˆ’' : '+'}</button></div><div class="px-2"><input type="text" class="live-input" value="${g.carrier}" oninput="syncC('${id}', this.value)"></div><div class="font-Inter text-white px-4">${id}</div><div class="px-2 text-center font-Inter text-gray-500">${g.total}</div><div class="text-center font-Inter text-gray-500">${g.units || 0}</div><div class="text-center font-Inter text-gray-500">${staged} STAGED</div></div><div id="tray-${id}" class="isd-container" style="display: ${g.open ? 'block' : 'none'}">${Object.keys(g.isds || {}).map(isdId => `<div class="audit-grid isd-row"><div></div><div class="px-2"><input type="text" class="live-input" style="color:var(--accent-green)" value="${g.isds[isdId].carrier}" oninput="syncIsdC('${id}', '${isdId}', this.value)"></div><div class="font-Inter text-gray-400 px-4">${isdId}</div><div class="text-center font-Inter text-white">${g.isds[isdId].qty} PLT</div><div class="text-center font-Inter text-gray-500">${g.isds[isdId].units}</div><div class="text-center"><span class="btn-detach" onclick="detach('${id}', '${isdId}')">Detach</span></div></div>`).join('')}</div>`;
                list.appendChild(div);
            });
        }

        function delPallet() { if(editIdx !== null) { warehouseData.pallets.splice(editIdx, 1); save(); closeModal(); render(); } }

        function commitPlacement() {
            const qRequested = parseInt(document.getElementById('in-qty').value)||1, car = document.getElementById('in-carrier').value, id = document.getElementById('in-id').value;
            const dropDate = new Date().toLocaleDateString('en-GB');
            if(editIdx !== null) { warehouseData.pallets[editIdx] = {...warehouseData.pallets[editIdx], carrier: car, id}; }
            else {
                const existingCount = warehouseData.pallets.filter(p => p.id === id).length;
                const remainingToDrop = qRequested - existingCount;
                if (remainingToDrop <= 0) { alert(`ALL PALLETS PLACED. \n\nShipment ID: ${id} \nTotal: ${qRequested} \nFloor: ${existingCount}`); return; }
                let droppedCount = 0, vStep = 2, validCols = [11, 9, 7, 5, 3];
                if(opMode === 'buffer' || opMode === 'breakdown') { vStep = (opMode === 'buffer') ? 3 : 6; validCols = [11, 8, 5, 2]; }
                let r = activeLoc.r;
                while (droppedCount < remainingToDrop && r <= ROWS - 1) {
                    for (let c of validCols) {
                        if (droppedCount >= remainingToDrop) break;
                        if (r === activeLoc.r && c > activeLoc.c) continue;
                        if (!isOcc(r, c)) { warehouseData.pallets.push({ r, c, qty: 1, carrier: car, id, date: dropDate }); droppedCount++; }
                    }
                    r += vStep;
                }
                if(!GROUPS[id]) GROUPS[id] = { carrier: car, total: qRequested, units: 0, isds: {}, open: false };
            }
            save(); closeModal(); render();
        }

        function toggleISA(id) { GROUPS[id].open = !GROUPS[id].open; renderAudit(); }
        function syncC(id, val) { GROUPS[id].carrier = val.toUpperCase(); warehouseData.pallets.forEach(p => { if(p.id===id) p.carrier = val.toUpperCase(); }); save(); render(); }
        function syncIsdC(isa, isd, val) { GROUPS[isa].isds[isd].carrier = val.toUpperCase(); }
        function detach(isaId, isdId) { const p = GROUPS[isaId], d = p.isds[isdId]; GROUPS[isdId] = { carrier: d.carrier + " (IND)", total: d.qty, units: d.units, isds: {[isdId]: d}, open: false }; p.total -= d.qty; delete p.isds[isdId]; if(p.total <= 0) delete GROUPS[isaId]; renderAudit(); updatePicker(); }
        function handleCSV(input) { const fr = new FileReader(); fr.onload = (e) => { const wb = XLSX.read(new Uint8Array(e.target.result), {type: 'array'}); const rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {header: 1}); GROUPS = {}; for(let i=1; i<rows.length; i++) { const l = rows[i]; if(!l || !l[2]) continue; const isa = String(l[2]), isd = String(l[3]), carrier = String(l[4]).toUpperCase(), qty = parseInt(l[6])||1; if(!GROUPS[isa]) GROUPS[isa] = { carrier, total: 0, units: 0, isds: {}, open: false }; GROUPS[isa].total += qty; GROUPS[isa].units += parseInt(l[7])||0; GROUPS[isa].isds[isd] = { carrier, qty, units: parseInt(l[7])||0 }; } updatePicker(); switchView('manifest'); }; fr.readAsArrayBuffer(input.files[0]); }
        function handleGridClick(r, c) { let tC = (c === COLS) ? COLS - 1 : c, tR = (r === ROWS) ? ROWS - 1 : r; if(isOcc(tR, tC)) return; activeLoc = { r: tR, c: tC }; editIdx = null; document.getElementById('modal-title').textContent = `Loc: ${COL_NAMES[tC-1]}${tR}`; document.getElementById('btn-drop').style.display = 'block'; document.getElementById('btn-relayout').style.display = 'none'; document.getElementById('edit-modal').classList.add('active'); updatePicker(); }
        function isOcc(r, c, ignore = []) { return warehouseData.pallets.some((p, i) => { if(ignore.includes(i)) return false; return !(r + 1 < p.r || r > p.r + 1 || c + 1 < p.c || c > p.c + 1); }); }
        
        function openEdit(idx) { 
            editIdx = idx; 
            const p = warehouseData.pallets[idx]; 
            document.getElementById('modal-title').textContent = `Manage Shipment: ${p.id}`; 
            document.getElementById('in-qty').value = GROUPS[p.id] ? GROUPS[p.id].total : 1; 
            document.getElementById('in-carrier').value = p.carrier; 
            document.getElementById('in-id').value = p.id || ''; 
            document.getElementById('btn-drop').style.display = 'none'; 
            document.getElementById('btn-relayout').style.display = 'block'; 
            document.getElementById('edit-modal').classList.add('active'); 
        }

        function closeModal() { document.getElementById('edit-modal').classList.remove('active'); }
        function switchView(v) { document.querySelectorAll('.section-view').forEach(s => s.style.display = 'none'); document.getElementById('view-' + v).style.display = 'block'; document.querySelectorAll('.btn-nav').forEach(b => b.classList.remove('btn-active')); document.getElementById('btn-' + v).classList.add('btn-active'); if(v==='manifest') renderAudit(); }
        function updatePicker() { const p = document.getElementById('shipment-picker'); p.innerHTML = '<option value="">-- MANUAL --</option>'; Object.keys(GROUPS).forEach(id => p.innerHTML += `<option value="${id}">${GROUPS[id].carrier} | ${id}</option>`); document.getElementById('picker-area').style.display = Object.keys(GROUPS).length > 0 ? 'block' : 'none'; }
        function applyPicker() { const id = document.getElementById('shipment-picker').value; if(id) { const g = GROUPS[id]; document.getElementById('in-qty').value = g.total; document.getElementById('in-carrier').value = g.carrier; document.getElementById('in-id').value = id; } }
        function handleRestore(input) { const fr = new FileReader(); fr.onload = (e) => { try { warehouseData = JSON.parse(e.target.result); save(); buildGrid(); render(); switchView('grid'); } catch(err){alert("Error");} }; fr.readAsText(input.files[0]); }
        function setOpMode(m) { opMode = m; document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active')); document.getElementById(`mode-${m}`).classList.add('active'); }
        function clearGrid() { if(confirm("Wipe grid?")) { warehouseData.pallets = []; save(); render(); } }
        function clearManifest() { if(confirm("Wipe manifest?")) { GROUPS = {}; renderAudit(); updatePicker(); } }
        function selGroup(id) { if(!id) return; moveState.selectedIndices = []; warehouseData.pallets.forEach((p, i) => { if(p.id === id) moveState.selectedIndices.push(i); }); render(); }
        function toggleSel(idx) { const p = moveState.selectedIndices.indexOf(idx); if(p > -1) moveState.selectedIndices.splice(p, 1); else moveState.selectedIndices.push(idx); render(); }
        function startDrag(e, idx) { e.preventDefault(); e.stopPropagation(); if(!moveState.selectedIndices.includes(idx)) moveState.selectedIndices = [idx]; const p = warehouseData.pallets[idx]; moveState.startR = p.r; moveState.startC = p.c; moveState.active = true; }
        function updateGhosts(r, c) { const dr = r - moveState.startR, dc = c - moveState.startC; moveState.selectedIndices.forEach(idx => { const p = warehouseData.pallets[idx], g = document.getElementById(`plt-${idx}`); if(g) { g.style.left = `${(p.c + dc - 1) * UNIT + 1}px`; g.style.top = `${(p.r + dr - 1) * UNIT + 1}px`; } }); }
        window.onmouseup = () => { if(moveState.active) { const dr = moveState.targetR - moveState.startR, dc = moveState.targetC - moveState.startC; let valid = true; moveState.selectedIndices.forEach(idx => { const p = warehouseData.pallets[idx]; let tr = p.r + dr, tc = p.c + dc; if(tr < 1 || tr > ROWS-1 || tc < 1 || tc > COLS-1 || isOcc(tr, tc, moveState.selectedIndices)) valid = false; }); if(valid) moveState.selectedIndices.forEach(idx => { warehouseData.pallets[idx].r += dr; warehouseData.pallets[idx].c += dc; }); moveState.active = false; moveState.selectedIndices = []; document.body.style.cursor = 'default'; save(); render(); } };
    </script>
</body>
</html>