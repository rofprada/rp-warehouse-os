<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RP LABEL GENERATOR v7.2</title>
    <style>
        :root { --bg-color: #121212; --panel-color: #1e1e1e; --input-bg: #000000; --text-main: #e0e0e0; --text-accent: #00CC99; --border-color: #444; --button-bg: #333; }
        body { font-family: 'Consolas', 'Monaco', 'Courier New', monospace; background-color: var(--bg-color); color: var(--text-main); padding: 20px; max-width: 1200px; margin: 0 auto; }
        h1 { color: var(--text-accent); border-bottom: 1px solid var(--border-color); padding-bottom: 10px; font-size: 1.5rem; text-transform: uppercase; letter-spacing: 2px; }
        .container { display: flex; gap: 20px; margin-top: 20px; }
        .controls { flex: 1; background: var(--panel-color); padding: 20px; border: 1px solid var(--border-color); }
        .preview { flex: 1; background: #252526; padding: 20px; border: 1px solid var(--border-color); display: flex; flex-direction: column; align-items: center; }
        
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; color: #888; font-size: 0.85rem; }
        label::before { content: "> "; color: var(--text-accent); }
        
        input, select, textarea { width: 100%; padding: 10px; background: var(--input-bg); border: 1px solid var(--border-color); color: white; font-family: inherit; box-sizing: border-box; outline: none; text-transform: uppercase; }
        input:focus, textarea:focus { border-color: var(--text-accent); }
        
        .row { display: flex; gap: 15px; }
        .col { flex: 1; }
        
        .btn-group { display: flex; gap: 10px; margin-top: 20px; border-top: 1px dashed var(--border-color); padding-top: 20px; }
        button { flex: 1; padding: 12px; background: var(--button-bg); border: 1px solid var(--text-main); color: var(--text-main); font-family: inherit; text-transform: uppercase; font-weight: bold; cursor: pointer; transition: all 0.1s; }
        button:hover { background: var(--text-accent); color: black; border-color: var(--text-accent); }
        
        .btn-reset { background: #330000; border-color: #550000; color: #ff9999; }
        .btn-reset:hover { background: #ff0000; color: white; border-color: red; }

        h2 { font-size: 1rem; color: #888; margin-top: 0; width: 100%; text-align: left; border-bottom: 1px solid #333; padding-bottom: 5px; }
        img { max-width: 100%; border: 1px solid #555; margin: 20px 0; background: white; }
        .hidden { display: none; }
        #app-content { display: none; }
        
        .section-header { color: #fff; background: #333; padding: 5px; margin: 15px 0 10px 0; font-size: 0.8rem; letter-spacing: 1px; }
        
        .stack-row { display: flex; gap: 10px; margin-bottom: 12px; align-items: center; background: #191919; padding: 8px; border: 1px solid #333; }
        .stack-row input[type="text"] { flex: 3; }
        .stack-row select { flex: 1; min-width: 60px; }
        
        .align-group { display: flex; gap: 4px; }
        .align-btn { background: #222; border: 1px solid #555; color: #888; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; cursor: pointer; padding: 4px; }
        .align-btn svg { width: 18px; height: 18px; fill: currentColor; }
        .align-btn:hover { background: #444; color: #fff; }
        .align-btn.active { background: #2d2d2d; border-color: var(--text-accent); color: var(--text-accent); }

        .chk-wrap { display: flex; align-items: center; gap: 5px; cursor: pointer; font-size: 0.8rem; color: #aaa; text-transform: none; }
        .chk-wrap input { width: auto; }
        
        .options-panel { display: flex; gap: 15px; margin-bottom: 15px; background: #222; padding: 10px; border: 1px dashed #444; }

        #lock-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; }
        #lock-msg { color: #00ff41; margin-bottom: 20px; font-size: 1.2rem; }
        #password-input { width: 300px; text-align: center; border: 1px solid #00ff41; padding: 15px; font-size: 1.2rem; letter-spacing: 5px; }
    </style>
</head>
<body>

    <div id="lock-screen">
        <div id="lock-msg">> SYSTEM_LOCKED // ENTER_ACCESS_CODE</div>
        <input type="password" id="password-input" placeholder="********" onkeyup="checkPass(event)">
    </div>

    <div id="app-content">
        <h1>> RP LABEL GENERATOR // v7.2</h1>
        <div class="container">
            <div class="controls">
                
                <div class="form-group" style="border-bottom: 1px solid #444; padding-bottom: 20px; margin-bottom: 20px;">
                    <label style="color: var(--text-accent); font-size: 1rem;">SELECT LAYOUT MODE</label>
                    <select id="layoutMode" onchange="toggleInputs()">
                        <option value="single">FORMAT A: SINGLE ISD (Standard)</option>
                        <option value="multi">FORMAT B: MULTI ISD (High Density)</option>
                        <option value="free">FORMAT C: DYNAMIC LAYOUT (Custom)</option>
                    </select>
                </div>

                <div id="standardHeaderGroup">
                    <div class="form-group">
                        <label>DATA HEADER</label>
                        <input type="text" id="header" value="HEADER" oninput="debouncedUpdate()" onchange="saveSettings()">
                    </div>
                </div>
                
                <div id="singleInputs">
                    <div class="form-group">
                        <label>DATA BARCODE (MAIN)</label>
                        <input type="text" id="barcode" value="SAMPLE" oninput="debouncedUpdate()">
                    </div>
                </div>

                <div id="multiInputs" class="hidden">
                    <div class="section-header">>> ROW 1 DATA</div>
                    <div class="row"><div class="col"><input type="text" id="po1" value="PO-88421" oninput="debouncedUpdate()"></div><div class="col"><input type="text" id="shp1" value="SHP-0012" oninput="debouncedUpdate()"></div></div>
                    <div class="section-header">>> ROW 2 DATA</div>
                    <div class="row"><div class="col"><input type="text" id="po2" placeholder="(Optional)" oninput="debouncedUpdate()"></div><div class="col"><input type="text" id="shp2" placeholder="(Optional)" oninput="debouncedUpdate()"></div></div>
                    <div class="section-header">>> ROW 3 DATA</div>
                    <div class="row"><div class="col"><input type="text" id="po3" placeholder="(Optional)" oninput="debouncedUpdate()"></div><div class="col"><input type="text" id="shp3" placeholder="(Optional)" oninput="debouncedUpdate()"></div></div>
                    <div class="section-header">>> ROW 4 DATA</div>
                    <div class="row"><div class="col"><input type="text" id="po4" placeholder="(Optional)" oninput="debouncedUpdate()"></div><div class="col"><input type="text" id="shp4" placeholder="(Optional)" oninput="debouncedUpdate()"></div></div>
                    <div class="section-header">>> ROW 5 DATA</div>
                    <div class="row"><div class="col"><input type="text" id="po5" placeholder="(Optional)" oninput="debouncedUpdate()"></div><div class="col"><input type="text" id="shp5" placeholder="(Optional)" oninput="debouncedUpdate()"></div></div>
                </div>

                <div id="freeInputs" class="hidden">
                    <div class="form-group">
                        <label>DATA_HEADER (CUSTOM)</label>
                        <input type="text" id="free_header" value="HEADER" oninput="debouncedUpdate()">
                    </div>

                    <div class="section-header">>> GLOBAL OPTIONS</div>
                    <div class="options-panel">
                        <label class="chk-wrap"><input type="checkbox" id="opt_header" checked onchange="debouncedUpdate()"> Print Header</label>
                        <label class="chk-wrap"><input type="checkbox" id="opt_date" checked onchange="debouncedUpdate()"> Print Date</label>
                        <label class="chk-wrap"><input type="checkbox" id="opt_counter" checked onchange="debouncedUpdate()"> Print Counter</label>
                    </div>

                    <div class="section-header">>> STACK BUILDER (LINES)</div>
                    <label style="margin-bottom:10px; color:#666; font-size:0.75rem;">CONTENT | SIZE | ALIGN | BARCODE</label>
                    <div id="stack-container">
                        <div class="stack-row">
                            <input type="text" id="free1_text" placeholder="Line 1" oninput="debouncedUpdate()">
                            <select id="free1_size" onchange="debouncedUpdate()"><option value="L">LRG</option><option value="M">MED</option><option value="S">SML</option></select>
                            <div class="align-group">
                                <div class="align-btn active" id="btn_f1_L" onclick="setAlign(1, 'L')"><svg viewBox="0 0 24 24"><path d="M3 6h18M3 12h12M3 18h18" stroke="currentColor" stroke-width="3" stroke-linecap="round"/></svg></div>
                                <div class="align-btn" id="btn_f1_C" onclick="setAlign(1, 'C')"><svg viewBox="0 0 24 24"><path d="M3 6h18M6 12h12M3 18h18" stroke="currentColor" stroke-width="3" stroke-linecap="round"/></svg></div>
                                <input type="hidden" id="free1_align" value="L">
                            </div>
                            <label class="chk-wrap"><input type="checkbox" id="free1_bc" onchange="debouncedUpdate()"> BC</label>
                        </div>
                        <div class="stack-row">
                            <input type="text" id="free2_text" placeholder="Line 2" oninput="debouncedUpdate()">
                            <select id="free2_size" onchange="debouncedUpdate()"><option value="L">LRG</option><option value="M" selected>MED</option><option value="S">SML</option></select>
                            <div class="align-group">
                                <div class="align-btn active" id="btn_f2_L" onclick="setAlign(2, 'L')"><svg viewBox="0 0 24 24"><path d="M3 6h18M3 12h12M3 18h18" stroke="currentColor" stroke-width="3" stroke-linecap="round"/></svg></div>
                                <div class="align-btn" id="btn_f2_C" onclick="setAlign(2, 'C')"><svg viewBox="0 0 24 24"><path d="M3 6h18M6 12h12M3 18h18" stroke="currentColor" stroke-width="3" stroke-linecap="round"/></svg></div>
                                <input type="hidden" id="free2_align" value="L">
                            </div>
                            <label class="chk-wrap"><input type="checkbox" id="free2_bc" onchange="debouncedUpdate()"> BC</label>
                        </div>
                        <div class="stack-row">
                            <input type="text" id="free3_text" placeholder="Line 3" oninput="debouncedUpdate()">
                            <select id="free3_size" onchange="debouncedUpdate()"><option value="L">LRG</option><option value="M">MED</option><option value="S" selected>SML</option></select>
                            <div class="align-group">
                                <div class="align-btn active" id="btn_f3_L" onclick="setAlign(3, 'L')"><svg viewBox="0 0 24 24"><path d="M3 6h18M3 12h12M3 18h18" stroke="currentColor" stroke-width="3" stroke-linecap="round"/></svg></div>
                                <div class="align-btn" id="btn_f3_C" onclick="setAlign(3, 'C')"><svg viewBox="0 0 24 24"><path d="M3 6h18M6 12h12M3 18h18" stroke="currentColor" stroke-width="3" stroke-linecap="round"/></svg></div>
                                <input type="hidden" id="free3_align" value="L">
                            </div>
                            <label class="chk-wrap"><input type="checkbox" id="free3_bc" onchange="debouncedUpdate()"> BC</label>
                        </div>
                    </div>

                    <div class="section-header">>> NOTES / BLOCK TEXT (OPTIONAL)</div>
                    <div class="stack-row">
                        <textarea id="free_note_text" rows="3" placeholder="Enter text (Press Enter for new line)..." oninput="debouncedUpdate()" style="resize:vertical; height: 60px;"></textarea>
                        <select id="free_note_size" onchange="debouncedUpdate()"><option value="L">LRG</option><option value="M">MED</option><option value="S" selected>SML</option></select>
                        <div class="align-group">
                            <div class="align-btn active" id="btn_fn_L" onclick="setNoteAlign('L')"><svg viewBox="0 0 24 24"><path d="M3 6h18M3 12h12M3 18h18" stroke="currentColor" stroke-width="3" stroke-linecap="round"/></svg></div>
                            <div class="align-btn" id="btn_fn_C" onclick="setNoteAlign('C')"><svg viewBox="0 0 24 24"><path d="M3 6h18M6 12h12M3 18h18" stroke="currentColor" stroke-width="3" stroke-linecap="round"/></svg></div>
                            <input type="hidden" id="free_note_align" value="L">
                        </div>
                    </div>
                </div>

                <div class="row" style="margin-top: 20px; border-top: 1px solid #333; padding-top: 10px;">
                    <div class="col form-group">
                        <label>PALLET QTY</label>
                        <input type="number" id="totalPallets" value="5" min="1" oninput="debouncedUpdate()">
                    </div>
                    <div class="col form-group">
                        <label>DATE</label>
                        <input type="text" id="datecode" value="" placeholder="DD/MM/YY" oninput="debouncedUpdate()" onchange="saveSettings()">
                    </div>
                </div>
                
                <select id="size" class="hidden"><option value="4x6">4x6</option></select>

                <div class="btn-group">
                    <button class="btn-reset" onclick="clearData()">CLEAR DATA</button>
                    <button onclick="downloadBatchZPL()">DOWNLOAD .ZPL</button>
                    <button onclick="printViaBrowser()">PRINT BATCH</button>
                </div>
            </div>
            <div class="preview">
                <h2>// PREVIEW_RENDER</h2>
                <img id="labelPreview" alt="NO_DATA" style="display:block;">
                <textarea id="rawZpl" class="hidden" readonly></textarea>
            </div>
        </div>
    </div>

    <script>
        const ACCESS_CODE = "IB2025"; 
        let debounceTimer;

        function saveSettings() {
            localStorage.setItem('rp_header', document.getElementById('header').value);
            localStorage.setItem('rp_date', document.getElementById('datecode').value);
        }

        function loadSettings() {
            if(localStorage.getItem('rp_header')) {
                document.getElementById('header').value = localStorage.getItem('rp_header');
                document.getElementById('free_header').value = localStorage.getItem('rp_header'); 
            }
            if(localStorage.getItem('rp_date')) {
                document.getElementById('datecode').value = localStorage.getItem('rp_date');
            } else {
                const d = new Date();
                const day = String(d.getDate()).padStart(2, '0');
                const month = String(d.getMonth() + 1).padStart(2, '0');
                document.getElementById('datecode').value = `${day}/${month}/${String(d.getFullYear()).slice(-2)}`;
            }
        }

        function debouncedUpdate() {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(updatePreview, 500);
        }

        function clearData() {
            if(confirm("CLEAR ALL DATA FIELDS? (Header and Date will remain)")) {
                const inputs = document.querySelectorAll('input[type="text"], textarea');
                inputs.forEach(input => {
                    if(input.id !== 'header' && input.id !== 'datecode' && input.id !== 'free_header') {
                        input.value = "";
                    }
                });
                debouncedUpdate();
            }
        }

        function checkPass(event) {
            if (event.key === "Enter") {
                const input = document.getElementById('password-input').value;
                if (input === ACCESS_CODE) {
                    document.getElementById('lock-screen').style.display = 'none';
                    document.getElementById('app-content').style.display = 'block';
                    loadSettings(); 
                    toggleInputs();
                    updatePreview();
                } else {
                    alert("ACCESS_DENIED");
                }
            }
        }

        function setAlign(lineNum, align) {
            document.getElementById(`free${lineNum}_align`).value = align;
            const btnL = document.getElementById(`btn_f${lineNum}_L`);
            const btnC = document.getElementById(`btn_f${lineNum}_C`);
            if (align === 'L') { btnL.classList.add('active'); btnC.classList.remove('active'); } 
            else { btnC.classList.add('active'); btnL.classList.remove('active'); }
            debouncedUpdate();
        }

        function setNoteAlign(align) {
            document.getElementById(`free_note_align`).value = align;
            const btnL = document.getElementById(`btn_fn_L`);
            const btnC = document.getElementById(`btn_fn_C`);
            if (align === 'L') { btnL.classList.add('active'); btnC.classList.remove('active'); } 
            else { btnC.classList.add('active'); btnL.classList.remove('active'); }
            debouncedUpdate();
        }

        function toggleInputs() {
            const mode = document.getElementById('layoutMode').value;
            document.getElementById('singleInputs').style.display = 'none';
            document.getElementById('multiInputs').style.display = 'none';
            document.getElementById('freeInputs').style.display = 'none';
            document.getElementById('standardHeaderGroup').style.display = 'block'; 

            if (mode === 'single') document.getElementById('singleInputs').style.display = 'block';
            if (mode === 'multi') document.getElementById('multiInputs').style.display = 'block';
            if (mode === 'free') {
                document.getElementById('freeInputs').style.display = 'block';
                document.getElementById('standardHeaderGroup').style.display = 'none'; 
            }
            debouncedUpdate();
        }

        function getSingleLabelZPL(currentCount, totalCount) {
            const mode = document.getElementById('layoutMode').value;
            const date = document.getElementById('datecode').value;
            const printWidth = 1218; 
            let labelLength = 1800; 

            const stdHeader = document.getElementById('header').value.toUpperCase();
            let stdFontSize = 170;
            if (stdHeader.length > 10) stdFontSize = 120;
            if (stdHeader.length > 15) stdFontSize = 90;
            
            let standardHeaderZPL = `
^XA
^PW${printWidth}
^LL${labelLength}
^FO0,100^FB${printWidth},2,10,C,0^A0N,${stdFontSize},${stdFontSize}^FD${stdHeader}^FS
^FO0,270^FB${printWidth},1,0,C,0^A0N,80,80^FDDATE: ${date}^FS
            `;

            if (mode === 'single') {
                const barcode = document.getElementById('barcode').value.toUpperCase();
                const charCount = barcode.length;
                let moduleWidth = 5; 
                let barcodePixelWidth = (11 * charCount + 35) * moduleWidth;
                if (barcodePixelWidth > 1150) { moduleWidth = 4; barcodePixelWidth = (11 * charCount + 35) * moduleWidth; }
                let startX = Math.floor((printWidth - barcodePixelWidth) / 2);
                if (startX < 0) startX = 0;

                return standardHeaderZPL + `
^FO${startX},500^BY${moduleWidth},3,400^BCN,400,N,N,N^FD${barcode}^FS
^FO0,920^FB${printWidth},1,0,C,0^A0N,80,80^FD${barcode}^FS
^FO0,1500^FB${printWidth},1,0,C,0^A0N,180,180^FD${currentCount} / ${totalCount}^FS
^XZ`.trim();
            }

            else if (mode === 'multi') {
                const pos = [1,2,3,4,5].map(i => document.getElementById(`po${i}`).value.toUpperCase());
                const shps = [1,2,3,4,5].map(i => document.getElementById(`shp${i}`).value.toUpperCase());

                let gridZPL = `
^FO50,380^A0N,50,50^FDPURCHASE ORDER:^FS
^FO650,380^A0N,50,50^FDSHIPMENT ID:^FS`;

                let currentY = 440;
                for(let i=0; i<5; i++) {
                    if(pos[i] || shps[i]) {
                        gridZPL += `
^FO50,${currentY}^A0N,60,60^FD${pos[i]}^FS
^FO50,${currentY+60}^BY3,3,70^BCN,70,N,N,N^FD${pos[i]}^FS
^FO650,${currentY}^A0N,60,60^FD${shps[i]}^FS
^FO650,${currentY+60}^BY3,3,70^BCN,70,N,N,N^FD${shps[i]}^FS`;
                        currentY += 200;
                    }
                }
                return standardHeaderZPL + gridZPL + `
^FO0,1550^FB${printWidth},1,0,C,0^A0N,180,180^FD${currentCount} / ${totalCount}^FS
^XZ`.trim();
            }

            else {
                let freeZPL = `^XA^PW${printWidth}^LL${labelLength}`;
                let currentY = 100; 

                if (document.getElementById('opt_header').checked) {
                    const customHeader = document.getElementById('free_header').value.toUpperCase();
                    let fSize = 170;
                    if (customHeader.length > 10) fSize = 120;
                    if (customHeader.length > 15) fSize = 90;
                    freeZPL += `^FO0,${currentY}^FB${printWidth},2,10,C,0^A0N,${fSize},${fSize}^FD${customHeader}^FS`;
                    currentY += fSize + 50; 
                }
                if (document.getElementById('opt_date').checked) {
                    freeZPL += `^FO0,${currentY}^FB${printWidth},1,0,C,0^A0N,80,80^FDDATE: ${date}^FS`;
                    currentY += 120;
                }

                for (let i = 1; i <= 3; i++) {
                    const txt = document.getElementById(`free${i}_text`).value.toUpperCase();
                    if (!txt) continue;
                    const sizeMode = document.getElementById(`free${i}_size`).value;
                    const alignMode = document.getElementById(`free${i}_align`).value;
                    const useBarcode = document.getElementById(`free${i}_bc`).checked;

                    let fH = 60, fW = 60; 
                    if (sizeMode === 'L') { fH=120; fW=120; }
                    if (sizeMode === 'S') { fH=40; fW=40; }

                    if (alignMode === 'C') {
                        freeZPL += `^FO0,${currentY}^FB${printWidth},1,0,C,0^A0N,${fH},${fW}^FD${txt}^FS\n`;
                    } else {
                        freeZPL += `^FO50,${currentY}^A0N,${fH},${fW}^FD${txt}^FS\n`;
                    }
                    currentY += fH + 20;

                    if (useBarcode) {
                        if (alignMode === 'C') {
                            const charCount = txt.length;
                            const modW = 3;
                            let bcW = (11 * charCount + 35) * modW;
                            let startX = Math.floor((printWidth - bcW) / 2);
                            if(startX < 0) startX = 0;
                            freeZPL += `^FO${startX},${currentY}^BY${modW},3,100^BCN,100,N,N,N^FD${txt}^FS\n`;
                        } else {
                            freeZPL += `^FO50,${currentY}^BY3,3,100^BCN,100,N,N,N^FD${txt}^FS\n`;
                        }
                        currentY += 140;
                    } else {
                        currentY += 20;
                    }
                }

                const noteTxt = document.getElementById('free_note_text').value.toUpperCase();
                if (noteTxt) {
                    // NEW: Replace newlines with ZPL command
                    const formattedNote = noteTxt.replace(/\n/g, '\\&');
                    const noteSize = document.getElementById('free_note_size').value;
                    const noteAlign = document.getElementById('free_note_align').value;
                    
                    // NEW: Updated sizes to match Stack Builder
                    let nH = 40, nW = 40; 
                    if (noteSize === 'L') { nH=120; nW=120; } // Was 80
                    if (noteSize === 'M') { nH=60; nW=60; }
                    
                    const alignChar = (noteAlign === 'C') ? 'C' : 'L';
                    const width = 1118; 
                    const xPos = 50;    
                    freeZPL += `^FO${xPos},${currentY}^FB${width},10,10,${alignChar},0^A0N,${nH},${nW}^FD${formattedNote}^FS\n`;
                    
                    // NEW: Calculate height based on lines
                    const lineCount = noteTxt.split('\n').length;
                    currentY += (nH * lineCount) + 40;
                }

                if (document.getElementById('opt_counter').checked) {
                    // Start counter lower to ensure no overlap if text is long
                    let counterY = Math.max(1550, currentY + 50);
                    freeZPL += `^FO0,${counterY}^FB${printWidth},1,0,C,0^A0N,180,180^FD${currentCount} / ${totalCount}^FS`;
                }

                freeZPL += "^XZ";
                return freeZPL;
            }
        }

        function updatePreview() {
            const total = document.getElementById('totalPallets').value;
            const zpl = getSingleLabelZPL(1, total);
            document.getElementById('rawZpl').value = zpl;
            const parts = ['4','6']; 
            const url = `http://api.labelary.com/v1/printers/12dpmm/labels/${parts[0]}x${parts[1]}/0/${encodeURIComponent(zpl)}`;
            document.getElementById('labelPreview').src = url;
        }

        function downloadBatchZPL() {
            const total = parseInt(document.getElementById('totalPallets').value) || 1;
            let batchZPL = "";
            for (let i = 1; i <= total; i++) {
                batchZPL += getSingleLabelZPL(i, total) + "\n";
            }
            const blob = new Blob([batchZPL], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `BATCH_LABELS.zpl`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        function printViaBrowser() {
            const total = parseInt(document.getElementById('totalPallets').value) || 1;
            const w = 4; const h = 6;
            const urls = [];
            for (let i = 1; i <= total; i++) {
                const zpl = getSingleLabelZPL(i, total);
                urls.push(`http://api.labelary.com/v1/printers/12dpmm/labels/${w}x${h}/0/${encodeURIComponent(zpl)}`);
            }
            const pWin = window.open('', '_blank', 'width=500,height=600');
            if (!pWin) { alert(">> ERROR: POPUP_BLOCKED"); return; }
            pWin.document.open();
            pWin.document.write(`
                <html><head><title>PRINT_SPOOLER</title><style>
                    body { background: #121212; color: #00ff41; font-family: monospace; padding: 20px; text-align: center; }
                    #log { border: 1px solid #333; padding: 20px; margin-top: 20px; font-weight: bold; }
                    img { max-width: 100%; display: none; } 
                    @media print {
                        @page { size: ${w}in ${h}in; margin: 0; padding: 0; }
                        html, body { margin: 0; padding: 0; background: none; height: 100%; }
                        #img-container { font-size: 0; line-height: 0; } 
                        img { display: block; width: 100%; height: 100%; margin: 0; padding: 0; page-break-after: always; }
                        img:last-child { page-break-after: auto; } 
                        #log, h1 { display: none; } 
                    }
                </style></head><body>
                    <h1>> SEQUENTIAL_SPOOLER // v7.2</h1>
                    <div id="log">> INITIALIZING QUEUE...</div>
                    <div id="img-container"></div>
                    <script>
                        const urls = ${JSON.stringify(urls)};
                        const container = document.getElementById('img-container');
                        const log = document.getElementById('log');
                        function loadNext(index) {
                            if (index >= urls.length) {
                                log.innerText = "> ALL_DATA_BUFFERED. LAUNCHING_PRINT_DIALOG...";
                                setTimeout(() => { window.print(); }, 1000);
                                return;
                            }
                            log.innerText = "> BUFFERING_SEGMENT: " + (index + 1) + " / " + urls.length;
                            const img = document.createElement('img');
                            img.src = urls[index];
                            img.onload = () => { container.appendChild(img); loadNext(index + 1); };
                            img.onerror = () => { setTimeout(() => { img.src = urls[index] + "&retry=" + Date.now(); }, 1000); };
                        }
                        loadNext(0);
                    <\/script></body></html>`);
            pWin.document.close();
        }
    </script>
</body>
</html>