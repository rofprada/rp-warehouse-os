<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RP DISPATCH CONSOLE v9.0</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        :root { --bg-color: #121212; --panel-color: #1e1e1e; --input-bg: #000000; --text-main: #e0e0e0; --text-accent: #00ff41; --border-color: #444; --button-bg: #333; }
        body { font-family: 'Consolas', 'Monaco', 'Courier New', monospace; background-color: var(--bg-color); color: var(--text-main); padding: 20px; max-width: 1400px; margin: 0 auto; }
        h1 { color: var(--text-accent); border-bottom: 1px solid var(--border-color); padding-bottom: 10px; font-size: 1.5rem; text-transform: uppercase; letter-spacing: 2px; }
        
        .upload-zone { border: 2px dashed #444; padding: 20px; text-align: center; margin-bottom: 20px; background: #1a1a1a; color: #888; transition: 0.2s; }
        .upload-zone:hover { border-color: var(--text-accent); color: #fff; cursor: pointer; background: #222; }

        .dispatch-table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 0.85rem; }
        .dispatch-table th { text-align: left; padding: 10px; border-bottom: 2px solid #444; color: #888; text-transform: uppercase; }
        .dispatch-table td { padding: 10px; border-bottom: 1px solid #333; vertical-align: middle; }
        .dispatch-table tr:hover { background: #252526; }

        .group-divider { border-bottom: 2px dashed var(--text-accent) !important; }

        .tag { padding: 3px 8px; border-radius: 3px; font-weight: bold; font-size: 0.75rem; }
        .tag-single { background: #1a3c5e; color: #58a6ff; border: 1px solid #2f5d8a; } 
        .tag-multi { background: #4d3818; color: #ffa657; border: 1px solid #855a20; } 

        .qty-input { width: 60px; padding: 5px; text-align: center; background: #000; border: 1px solid #555; color: #fff; font-weight: bold; }
        .qty-input:focus { border-color: var(--text-accent); outline: none; }
        
        .btn-print { background: #333; border: 1px solid #555; color: #fff; padding: 6px 12px; cursor: pointer; text-transform: uppercase; font-weight: bold; }
        .btn-print:hover { background: var(--text-accent); color: #000; border-color: var(--text-accent); }
        
        .global-header { margin-bottom: 20px; display: flex; align-items: center; gap: 10px; background: #1a1a1a; padding: 10px; border: 1px solid #333; }
        .global-header label { color: #888; font-weight: bold; }
        .global-header input { background: #000; border: 1px solid #444; color: #fff; padding: 5px 10px; width: 200px; text-transform: uppercase; }

        #help-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; justify-content: center; align-items: center; }
        .help-content { background: #1e1e1e; padding: 30px; border: 1px solid #444; max-width: 600px; line-height: 1.6; }
        .help-content h2 { color: var(--text-accent); border-bottom: 1px solid #444; }
        .help-key { color: #fff; font-weight: bold; }
        .help-val { color: #888; margin-bottom: 10px; display: block; }

        #lock-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; }
        #password-input { width: 300px; text-align: center; border: 1px solid #00ff41; padding: 15px; font-size: 1.2rem; letter-spacing: 5px; }
        
        .hidden { display: none; }
        .top-bar { display: flex; justify-content: space-between; align-items: center; }
    </style>
</head>
<body>

    <div id="lock-screen">
        <div style="color: #00ff41; margin-bottom: 20px; font-size: 1.2rem;">> SYSTEM_LOCKED // ENTER_ACCESS_CODE</div>
        <input type="password" id="password-input" placeholder="********" onkeyup="checkPass(event)">
    </div>

    <div id="help-modal" onclick="document.getElementById('help-modal').style.display='none'">
        <div class="help-content" onclick="event.stopPropagation()">
            <h2>// PRINTER CONFIGURATION GUIDE</h2>
            <span class="help-key">1. REMOVE HEADERS/FOOTERS</span>
            <span class="help-val">In Print Dialog > "More settings" > UNCHECK "Headers and footers".</span>
            <span class="help-key">2. PAPER SIZE</span>
            <span class="help-val">Ensure Paper Size is <b>4" x 6"</b> (100mm x 150mm).</span>
            <span class="help-key">3. DATA MAPPING</span>
            <span class="help-val">Col A: Date | Col C: Job ID | Col D: ISD | Col E: Carrier (Header) | Col G: Pallets</span>
            <button onclick="document.getElementById('help-modal').style.display='none'" style="margin-top: 20px; width: 100%; padding: 10px; background: #333; color: white; border: 1px solid #555; cursor: pointer;">CLOSE</button>
        </div>
    </div>

    <div id="app-content" class="hidden">
        <div class="top-bar">
            <h1>> RP DISPATCH CONSOLE v9.0</h1>
            <button onclick="document.getElementById('help-modal').style.display='flex'" style="background:none; border:1px solid #444; color:#888; padding: 5px 10px; cursor: pointer;">? HELP</button>
        </div>
        
        <div class="global-header">
            <label>FALLBACK HEADER:</label>
            <input type="text" id="fallbackHeader" value="INBOUND" onchange="saveHeader()">
            <span style="color: #666; font-size: 0.8rem;">(Used only if 'Carrier' column is empty)</span>
        </div>

        <div class="upload-zone">
            <label style="display:block; width:100%; height:100%;">
                <span id="uploadText">ðŸ“‚ STEP 1: UPLOAD EXCEL / CSV SCHEDULE</span>
                <input type="file" id="fileUpload" accept=".csv, .xlsx, .xls" style="display:none" onchange="handleFile(this)">
            </label>
        </div>

        <table class="dispatch-table">
            <thead>
                <tr>
                    <th style="width: 100px;">TYPE</th>
                    <th style="width: 150px;">APPT ID (JOB)</th>
                    <th>CARRIER (HEADER)</th>
                    <th>DATE</th>
                    <th>CONTENTS (ISD)</th>
                    <th style="width: 100px; text-align: center;">QTY</th>
                    <th style="width: 100px;">ACTION</th>
                </tr>
            </thead>
            <tbody id="jobTableBody">
                <tr><td colspan="7" style="text-align:center; color:#444; padding: 30px;">NO DATA LOADED.</td></tr>
            </tbody>
        </table>

    </div>

    <script>
        const ACCESS_CODE = "IB2025"; 
        let JOB_REGISTRY = []; 

        function checkPass(event) {
            if (event.key === "Enter") {
                if (document.getElementById('password-input').value === ACCESS_CODE) {
                    document.getElementById('lock-screen').style.display = 'none';
                    document.getElementById('app-content').classList.remove('hidden');
                    if(localStorage.getItem('rp_fallback')) {
                        document.getElementById('fallbackHeader').value = localStorage.getItem('rp_fallback');
                    }
                } else { alert("ACCESS_DENIED"); }
            }
        }
        function saveHeader() {
            localStorage.setItem('rp_fallback', document.getElementById('fallbackHeader').value);
        }

        function formatShortDate(rawDate) {
            if (!rawDate) return "";
            if (typeof rawDate === 'number' && rawDate > 40000) {
                const dateObj = new Date((rawDate - (25567 + 2)) * 86400 * 1000); 
                const day = dateObj.getDate();
                const months = ["", "JAN", "FEB", "MAR", "APR", "MAY", "JUN", "JUL", "AUG", "SEP", "OCT", "NOV", "DEC"];
                return day + months[dateObj.getMonth() + 1]; 
            }
            const str = String(rawDate).trim();
            if (str.includes('-')) {
                const parts = str.split('-');
                if (parts.length === 3) {
                    const day = parts[2];
                    const monthIdx = parseInt(parts[1]);
                    const months = ["", "JAN", "FEB", "MAR", "APR", "MAY", "JUN", "JUL", "AUG", "SEP", "OCT", "NOV", "DEC"];
                    return day + months[monthIdx];
                }
            }
            return str;
        }

        function handleFile(input) {
            const file = input.files[0];
            if(file) {
                document.getElementById('uploadText').innerText = "âœ… LOADED: " + file.name;
                const reader = new FileReader();
                reader.onload = function(e) {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const sheetName = workbook.SheetNames[0];
                    const rawData = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], {header: 1});
                    parseDataToJobs(rawData);
                };
                reader.readAsArrayBuffer(file);
            }
        }

        function parseDataToJobs(rows) {
            JOB_REGISTRY = []; 
            const groups = {};
            // MAPPING: A=0(Date), B=1, C=2(Appt), D=3(ISD), E=4(Carrier), F=5, G=6(Pallets)
            
            for(let i=1; i<rows.length; i++) { 
                const row = rows[i];
                if(!row || row.length === 0) continue;
                const apptId = row[2] || "UNKNOWN_ID";
                if(!groups[apptId]) groups[apptId] = [];
                groups[apptId].push(row);
            }

            Object.keys(groups).forEach(key => {
                const groupRows = groups[key];
                const count = groupRows.length;
                const rawDate = groupRows[0][0];
                const formattedDate = formatShortDate(rawDate); 
                const carrier = groupRows[0][4] || ""; // Column E

                if (count >= 2 && count <= 5) {
                    JOB_REGISTRY.push({
                        id: key, type: 'B', date: formattedDate, carrier: carrier,
                        isds: groupRows.map(r => r[3]), defaultQty: 1 
                    });
                } else {
                    groupRows.forEach(r => {
                        let pCount = parseInt(r[6]); 
                        if(isNaN(pCount) || pCount < 1) pCount = 1;
                        JOB_REGISTRY.push({
                            id: key, type: 'A', date: formattedDate, carrier: r[4] || "",
                            isds: [r[3]], defaultQty: pCount
                        });
                    });
                }
            });
            renderDashboard();
        }

        function renderDashboard() {
            const tbody = document.getElementById('jobTableBody');
            tbody.innerHTML = "";
            JOB_REGISTRY.forEach((job, index) => {
                const tr = document.createElement('tr');
                
                // Group Divider Logic
                const nextJob = JOB_REGISTRY[index + 1];
                if (!nextJob || nextJob.id !== job.id) {
                    tr.classList.add('group-divider');
                }

                let contentHtml = "";
                if(job.type === 'A') {
                    contentHtml = `<span style="color:#fff;">${job.isds[0]}</span>`;
                } else {
                    contentHtml = `<div style="font-size:0.75rem; color:#aaa;">CONTAINS ${job.isds.length} ITEMS:</div>`;
                    job.isds.forEach(isd => { contentHtml += `<div style="color:#fff;">â€¢ ${isd}</div>`; });
                }
                const tag = job.type === 'A' 
                    ? `<span class="tag tag-single">FORMAT A</span>` 
                    : `<span class="tag tag-multi">FORMAT B</span>`;

                tr.innerHTML = `
                    <td>${tag}</td>
                    <td style="font-weight:bold; color:#fff;">${job.id}</td>
                    <td style="color: var(--text-accent);">${job.carrier || "<i>(Fallback)</i>"}</td>
                    <td style="color: #fff; font-weight:bold;">${job.date || "N/A"}</td>
                    <td>${contentHtml}</td>
                    <td style="text-align:center;">
                        <input type="number" class="qty-input" id="qty-${index}" value="${job.defaultQty}" min="1">
                    </td>
                    <td><button class="btn-print" onclick="printJob(${index})">PRINT</button></td>
                `;
                tbody.appendChild(tr);
            });
        }

        function printJob(index) {
            const job = JOB_REGISTRY[index];
            const qtyInput = document.getElementById(`qty-${index}`);
            const totalLabels = parseInt(qtyInput.value) || 1;
            
            // Logic: Use Carrier from Excel, otherwise use Fallback Text Box
            let headerText = job.carrier;
            if(!headerText || headerText.trim() === "") {
                headerText = document.getElementById('fallbackHeader').value;
            }
            headerText = headerText.toUpperCase();

            const zplArray = [];
            if (job.type === 'A') {
                const isd = job.isds[0];
                for(let i=1; i<=totalLabels; i++) {
                    zplArray.push(generateZPL_A(headerText, job.date, isd, i, totalLabels));
                }
            } else {
                for(let i=1; i<=totalLabels; i++) {
                    zplArray.push(generateZPL_B(headerText, job.date, job.isds, i, totalLabels));
                }
            }
            launchPrintWindow(zplArray);
        }

        function generateZPL_A(header, date, barcode, current, total) {
            // Header Size Logic
            let fontSize = 170;
            if (header.length > 10) fontSize = 120;
            if (header.length > 15) fontSize = 90;

            // Barcode Centering Logic
            let charCount = String(barcode).length;
            let modW = 5; 
            let bcW = (11 * charCount + 35) * modW;
            if(bcW > 1150) modW = 4;
            let startX = Math.floor((1218 - ((11 * charCount + 35) * modW)) / 2);
            if(startX < 0) startX = 0;

            // UPDATED: Date size increased to 180, Y pos adjusted
            // Header: Y=50
            // Date: Y=230 (Size 180)
            // Barcode: Y=520 (Moved down slightly to accommodate big date)
            return `^XA^PW1218^LL1800
^FO0,50^FB1218,2,10,C,0^A0N,${fontSize},${fontSize}^FD${header}^FS
^FO0,230^FB1218,1,0,C,0^A0N,180,180^FDDATE: ${date}^FS
^FO${startX},520^BY${modW},3,400^BCN,400,N,N,N^FD${barcode}^FS
^FO0,940^FB1218,1,0,C,0^A0N,80,80^FD${barcode}^FS
^FO0,1500^FB1218,1,0,C,0^A0N,180,180^FD${current} / ${total}^FS
^XZ`;
        }

        function generateZPL_B(header, date, isdList, current, total) {
            // Header Size Logic
            let fontSize = 170;
            if (header.length > 10) fontSize = 120;
            if (header.length > 15) fontSize = 90;

            // UPDATED: Date size increased to 180
            // Shifted grid down to accommodate
            let zpl = `^XA^PW1218^LL1800
^FO0,50^FB1218,2,10,C,0^A0N,${fontSize},${fontSize}^FD${header}^FS
^FO0,230^FB1218,1,0,C,0^A0N,180,180^FDDATE: ${date}^FS
^FO50,450^A0N,50,50^FDPURCHASE ORDER:^FS^FO650,450^A0N,50,50^FDSHIPMENT ID:^FS`;
            
            let currentY = 510;
            isdList.forEach(isd => {
                zpl += `^FO650,${currentY}^A0N,60,60^FD${isd}^FS
^FO650,${currentY+60}^BY3,3,70^BCN,70,N,N,N^FD${isd}^FS`;
                currentY += 200;
            });
            zpl += `^FO0,1550^FB1218,1,0,C,0^A0N,180,180^FD${current} / ${total}^FS^XZ`;
            return zpl;
        }

        function launchPrintWindow(zplList) {
            const w = 4; const h = 6;
            const urls = zplList.map(z => `http://api.labelary.com/v1/printers/12dpmm/labels/${w}x${h}/0/${encodeURIComponent(z)}`);
            
            const pWin = window.open('', '_blank', 'width=500,height=600');
            if(!pWin) { alert("POPUP BLOCKED. Please allow popups."); return; }
            
            pWin.document.open();
            pWin.document.write(`
                <html><head><title>PRINTING...</title><style>
                    @page { size: 101.6mm 152.4mm; margin: 0; }
                    body { margin: 0; padding: 0; background: #000; color: #0f0; font-family: monospace; text-align: center; }
                    .label-page { width: 101.6mm; height: 152.4mm; page-break-after: always; overflow: hidden; position: relative; }
                    img { width: 100%; height: 100%; display: block; object-fit: contain; }
                    @media print { body { background: none; } #log { display: none; } }
                </style></head><body>
                <div id="log">RENDERING...</div>
                <div id="con"></div>
                <script>
                    const urls = ${JSON.stringify(urls)};
                    const con = document.getElementById('con');
                    let loaded = 0;
                    function loadNext(i) {
                        if(i >= urls.length) { 
                            document.getElementById('log').innerText = "DONE. OPENING PRINTER..."; 
                            setTimeout(() => { window.print(); window.close(); }, 500); 
                            return; 
                        }
                        const div = document.createElement('div');
                        div.className = 'label-page';
                        const img = document.createElement('img');
                        img.src = urls[i];
                        img.onload = () => { div.appendChild(img); con.appendChild(div); loaded++; document.getElementById('log').innerText = "RENDERED " + loaded + " / " + urls.length; loadNext(i+1); };
                        img.onerror = () => { setTimeout(() => loadNext(i), 1000); };
                    }
                    loadNext(0);
                <\/script></body></html>`);
            pWin.document.close();
        }
    </script>
</body>
</html>