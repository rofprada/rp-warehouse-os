<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RP LABELTOOL v10.10</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    
    <style>
        /* --- V10.10 THEME (No Lock Screen) --- */
        :root {
            --bg-app: #0d1117;       
            --bg-panel: #161b22;     
            --bg-header: #21262d;    
            --bg-input: #010409;     
            --text-main: #c9d1d9;    
            --text-muted: #8b949e;   
            --accent-green: #2ea043; 
            --accent-blue: #58a6ff;
            --accent-purple: #bc8cff;
            --accent-red: #da3633;
            --border-color: #30363d; 
            --radius-sm: 4px; 
        }

        body { font-family: 'Inter', sans-serif; background-color: var(--bg-app); color: var(--text-main); padding: 40px; max-width: 1400px; margin: 0 auto; }

        /* HEADER */
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; border-bottom: 1px solid var(--border-color); padding-bottom: 20px; }
        
        h1 {
            font-family: "Segoe UI Variable Display", "Segoe UI", Helvetica, Arial, sans-serif;
            font-weight: 400;
            font-size: 1.8rem;
            letter-spacing: 4px;
            text-transform: uppercase;
            margin: 0;
            display: flex; align-items: center; gap: 15px; color: #fff;
        }
        h1::before { content: ""; display: block; width: 6px; height: 28px; background: var(--accent-green); }

        .btn-help {
            background: transparent; border: 1px solid var(--border-color); color: var(--text-muted);
            padding: 8px 16px; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: 0.2s;
            border-radius: var(--radius-sm);
        }
        .btn-help:hover { color: var(--text-main); border-color: var(--text-main); }

        /* CONFIG & UPLOAD */
        .config-bar { margin-bottom: 20px; }
        .global-input-group { display: flex; align-items: center; gap: 10px; }
        .global-input-group label { color: var(--text-muted); font-size: 0.8rem; font-weight: 600; text-transform: uppercase; }
        .global-input-group input { background: var(--bg-panel); border: 1px solid var(--border-color); color: var(--text-main); padding: 8px 12px; font-family: inherit; width: 200px; text-transform: uppercase; border-radius: var(--radius-sm); outline: none; }
        .global-input-group input:focus { border-color: var(--accent-green); }

        .upload-zone { background: var(--bg-panel); border: 1px dashed var(--border-color); padding: 40px; text-align: center; margin-bottom: 40px; cursor: pointer; transition: 0.2s; border-radius: var(--radius-sm); }
        .upload-zone:hover { border-color: var(--accent-green); background: var(--bg-header); }
        #uploadText { font-weight: 600; color: var(--text-muted); font-size: 0.9rem; letter-spacing: 0.5px; }

        /* CARDS */
        .isa-bundle { background: var(--bg-panel); border: 1px solid var(--border-color); margin-bottom: 25px; border-radius: var(--radius-sm); }
        .isa-header { background: var(--bg-header); padding: 12px 20px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; border-radius: var(--radius-sm) var(--radius-sm) 0 0; }
        .isa-info { display: flex; align-items: center; gap: 15px; }
        .isa-id { color: #fff; font-size: 1.1rem; font-weight: 700; letter-spacing: 0.5px; font-family: 'Inter', sans-serif; }
        .isa-time-badge { color: var(--accent-green); font-size: 0.85rem; font-weight: 600; background: rgba(46, 160, 67, 0.15); padding: 4px 8px; border-radius: var(--radius-sm); }
        
        .carrier-edit { background: var(--bg-input); border: 1px solid var(--border-color); color: #fff; padding: 6px; width: 140px; text-align: center; font-weight: 600; border-radius: var(--radius-sm); outline: none; font-family: 'Inter', sans-serif; }
        .carrier-edit:focus { border-color: var(--accent-green); }

        .mode-toggle { display: flex; background: var(--bg-input); border: 1px solid var(--border-color); border-radius: var(--radius-sm); }
        .mode-btn { border: none; padding: 6px 12px; cursor: pointer; font-size: 0.75rem; font-weight: 600; color: var(--text-muted); background: transparent; font-family: 'Inter', sans-serif; }
        .mode-btn.active { background: #262626; color: #e0e0e0; border-left: 1px solid var(--border-color); border-right: 1px solid var(--border-color); }
        .mode-btn:hover:not(.active) { color: #fff; }

        /* TABLE */
        .dispatch-table { width: 100%; border-collapse: collapse; }
        .dispatch-table th { text-align: left; padding: 10px 20px; border-bottom: 1px solid var(--border-color); color: var(--text-muted); font-size: 0.7rem; text-transform: uppercase; letter-spacing: 1px; }
        .dispatch-table td { padding: 12px 20px; border-bottom: 1px solid var(--border-color); vertical-align: middle; color: var(--text-main); font-size: 0.9rem; }
        .dispatch-table tr:last-child td { border-bottom: none; }
        
        .qty-input { width: 60px; text-align: center; background: var(--bg-input); border: 1px solid var(--border-color); color: #fff; padding: 6px; border-radius: var(--radius-sm); font-weight: 600; }
        .qty-input:focus { border-color: var(--accent-green); outline: none; }
        .po-input { width: 100px; background: var(--bg-input); border: 1px solid var(--border-color); color: var(--text-muted); padding: 6px; border-radius: var(--radius-sm); font-size: 0.8rem; margin-right: 8px; }
        .po-input:focus { border-color: var(--accent-green); color: #fff; outline: none; }

        .tag { padding: 4px 8px; border-radius: var(--radius-sm); font-weight: 700; font-size: 0.7rem; letter-spacing: 0.5px;}
        .tag-single { color: var(--accent-blue); background: rgba(56, 139, 253, 0.15); border: 1px solid rgba(56, 139, 253, 0.4); }
        .tag-multi { color: #fbbf24; background: rgba(251, 191, 36, 0.15); border: 1px solid rgba(251, 191, 36, 0.4); }
        .tag-master { color: var(--accent-purple); background: rgba(188, 140, 255, 0.15); border: 1px solid rgba(188, 140, 255, 0.4); }
        
        .btn-action-group { display: flex; gap: 10px; }
        .btn { border: none; padding: 8px 16px; cursor: pointer; font-weight: 600; font-size: 0.8rem; border-radius: var(--radius-sm); transition: 0.2s; display: flex; align-items: center; gap: 8px; text-transform: uppercase; letter-spacing: 0.5px; font-family: 'Inter', sans-serif; }
        .btn-print-row { background: transparent; border: 1px solid var(--border-color); color: var(--text-muted); }
        .btn-print-row:hover { border-color: var(--text-main); color: var(--text-main); }
        .btn-print-row.printed { background: var(--bg-header); color: var(--accent-green); border-color: var(--accent-green); }
        .btn-print-all { background: var(--accent-green); color: #fff; border: 1px solid var(--accent-green); }
        .btn-print-all:hover { background: #26903b; border-color: #26903b; }
        .btn-print-all.printed { background: transparent; color: var(--accent-green); border-color: var(--accent-green); }
        .btn-delete { background: transparent; border: 1px solid var(--border-color); color: var(--accent-red); padding: 8px; justify-content: center; }
        .btn-delete:hover { background: rgba(218, 54, 51, 0.15); border-color: var(--accent-red); }

        /* MODAL */
        #help-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; justify-content: center; align-items: center; }
        .help-content { background: var(--bg-panel); padding: 30px; border: 1px solid var(--border-color); max-width: 500px; }
        .help-content h2 { margin-top: 0; color: #fff; font-size: 1.1rem; font-family: 'Inter', sans-serif; letter-spacing: 1px;}
        .help-key { color: var(--accent-green); font-weight: 600; display: block; margin-bottom: 5px; font-size: 0.85rem; text-transform: uppercase;}
        .help-val { color: var(--text-muted); margin-bottom: 20px; display: block; font-size: 0.9rem; }
        .btn-close { width: 100%; padding: 10px; background: var(--bg-header); color: #fff; border: 1px solid var(--border-color); cursor: pointer; font-weight: 600;}
        
        .empty-state { text-align: center; padding: 60px; color: var(--text-muted); font-weight: 600; font-size: 1.2rem; border: 1px dashed var(--border-color); border-radius: var(--radius-sm);}
    </style>
</head>
<body>

    <div id="help-modal" onclick="document.getElementById('help-modal').style.display='none'">
        <div class="help-content" onclick="event.stopPropagation()">
            <h2>CONFIG GUIDE</h2>
            <span class="help-key">1. Browser Print Settings</span>
            <span class="help-val">Uncheck "Headers and footers". Set Margins to None.</span>
            <span class="help-key">2. Paper Size</span>
            <span class="help-val">4" x 6" (100mm x 150mm).</span>
            <button class="btn-close" onclick="document.getElementById('help-modal').style.display='none'">CLOSE</button>
        </div>
    </div>

    <div id="app-content">
        <div class="top-bar">
            <h1>RP LABELTOOL v10.10</h1>
            <div style="display:flex; gap: 10px;">
                <button class="btn-help" onclick="window.location.href='index.html'">BACK TO HUB</button>
                <button class="btn-help" onclick="document.getElementById('help-modal').style.display='flex'">CONFIG</button>
            </div>
        </div>
        
        <div class="config-bar">
            <div class="global-input-group">
                <label>Default Header:</label>
                <input type="text" id="fallbackHeader" value="INBOUND" onchange="saveHeader()">
            </div>
        </div>

        <div class="upload-zone">
            <label style="display:block; width:100%; height:100%; cursor: pointer;">
                <span id="uploadText">CLICK TO UPLOAD SCHEDULE (.XLSX / .CSV)</span>
                <input type="file" id="fileUpload" accept=".csv, .xlsx, .xls" style="display:none" onchange="handleFile(this)">
            </label>
        </div>

        <div id="dashboardArea">
            <div class="empty-state">NO DATA LOADED</div>
        </div>
    </div>

    <script>
        let ISA_GROUPS = {}; 

        // Load Header Preference
        if(localStorage.getItem('rp_fallback')) {
            document.getElementById('fallbackHeader').value = localStorage.getItem('rp_fallback');
        }

        function saveHeader() {
            localStorage.setItem('rp_fallback', document.getElementById('fallbackHeader').value);
        }

        // --- FILE HANDLING & PARSING (Same as v10.9) ---
        function formatShortDate(rawDate) {
            if (!rawDate) return "";
            if (typeof rawDate === 'number' && rawDate > 40000) {
                const dateObj = new Date((rawDate - (25567 + 2)) * 86400 * 1000); 
                const day = dateObj.getDate();
                const months = ["", "JAN", "FEB", "MAR", "APR", "MAY", "JUN", "JUL", "AUG", "SEP", "OCT", "NOV", "DEC"];
                return day + months[dateObj.getMonth() + 1]; 
            }
            const str = String(rawDate).trim();
            if (str.includes('-')) {
                const parts = str.split('-');
                if (parts.length === 3) {
                    const day = parts[2];
                    const monthIdx = parseInt(parts[1]);
                    const months = ["", "JAN", "FEB", "MAR", "APR", "MAY", "JUN", "JUL", "AUG", "SEP", "OCT", "NOV", "DEC"];
                    return day + months[monthIdx];
                }
            }
            return str;
        }

        function formatTime(rawTime) {
            if (!rawTime) return "";
            if (typeof rawTime === 'number') {
                const totalSeconds = Math.floor(rawTime * 86400);
                const hours = Math.floor(totalSeconds / 3600);
                const minutes = Math.floor((totalSeconds % 3600) / 60);
                const ampm = hours >= 12 ? 'PM' : 'AM';
                const showHour = hours % 12 || 12; 
                const showMin = String(minutes).padStart(2, '0');
                return `${showHour}:${showMin} ${ampm}`;
            }
            return String(rawTime);
        }

        function handleFile(input) {
            const file = input.files[0];
            if(file) {
                document.getElementById('uploadText').innerText = "✅ FILE LOADED: " + file.name;
                const reader = new FileReader();
                reader.onload = function(e) {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const sheetName = workbook.SheetNames[0];
                    const rawData = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], {header: 1});
                    parseData(rawData);
                };
                reader.readAsArrayBuffer(file);
            }
        }

        function parseData(rows) {
            ISA_GROUPS = {}; 
            const tempGroups = {};
            for(let i=1; i<rows.length; i++) { 
                const row = rows[i];
                if(!row || row.length === 0) continue;
                const apptId = row[2] || "UNKNOWN_ID";
                if(!tempGroups[apptId]) tempGroups[apptId] = [];
                tempGroups[apptId].push(row);
            }

            Object.keys(tempGroups).forEach(key => {
                const groupRows = tempGroups[key];
                const rawDate = groupRows[0][0];
                const rawTime = groupRows[0][1]; 
                const carrier = groupRows[0][4] || ""; 

                let totalPallets = 0;
                const individualJobs = [];

                groupRows.forEach(r => {
                    let pCount = parseInt(r[6]); 
                    if(isNaN(pCount) || pCount < 1) pCount = 1;
                    totalPallets += pCount;
                    individualJobs.push({ type: 'A', isds: [r[3]], qty: pCount });
                });

                const count = groupRows.length;
                let defaultJobs = [];
                if (count >= 2 && count <= 5) {
                    const bQty = totalPallets > 0 ? totalPallets : 1;
                    const bItems = groupRows.map(r => ({ isd: r[3], po: '' }));
                    defaultJobs = [{ type: 'B', items: bItems, qty: bQty }];
                } else {
                    defaultJobs = individualJobs;
                }

                ISA_GROUPS[key] = {
                    id: key, date: formatShortDate(rawDate), time: formatTime(rawTime), carrier: carrier,
                    mode: 'expanded', jobs: defaultJobs, 
                    condensedJob: { type: 'A', isds: [key], qty: totalPallets }
                };
            });
            renderDashboard();
        }

        function toggleMode(isaKey, mode) { ISA_GROUPS[isaKey].mode = mode; renderDashboard(); }

        function deleteBundle(isaKey) {
            if(confirm("Remove this bundle from view?")) {
                delete ISA_GROUPS[isaKey];
                renderDashboard();
            }
        }

        function renderDashboard() {
            const container = document.getElementById('dashboardArea');
            container.innerHTML = "";

            Object.keys(ISA_GROUPS).forEach(isaKey => {
                const bundle = ISA_GROUPS[isaKey];
                const btnExpandedClass = bundle.mode === 'expanded' ? 'active' : '';
                const btnCondensedClass = bundle.mode === 'condensed' ? 'active' : '';

                const headerHtml = `
                    <div class="isa-header">
                        <div class="isa-info">
                            <span class="isa-id">${bundle.id}</span>
                            <span class="isa-time-badge">${bundle.time || "N/A"}</span>
                            <input type="text" class="carrier-edit" id="carrier-${isaKey}" value="${bundle.carrier}" placeholder="CARRIER">
                            <div class="mode-toggle">
                                <button class="mode-btn ${btnExpandedClass}" onclick="toggleMode('${isaKey}', 'expanded')">INDIVIDUAL</button>
                                <button class="mode-btn ${btnCondensedClass}" onclick="toggleMode('${isaKey}', 'condensed')">MASTER</button>
                            </div>
                        </div>
                        <div class="btn-action-group">
                            <button class="btn btn-print-all" onclick="printBundle('${isaKey}', this)">PRINT BUNDLE</button>
                            <button class="btn btn-delete" onclick="deleteBundle('${isaKey}')">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                            </button>
                        </div>
                    </div>
                `;

                let rowsHtml = "";
                if (bundle.mode === 'expanded') {
                    bundle.jobs.forEach((job, idx) => {
                        let tag, content;
                        if(job.type === 'A') {
                            tag = `<span class="tag tag-single">FORMAT A</span>`;
                            content = `<span style="font-weight:600; color: #fff;">${job.isds[0]}</span>`;
                        } else {
                            tag = `<span class="tag tag-multi">FORMAT B</span>`;
                            content = `<div style="font-size:0.85rem; color:#888; margin-bottom: 5px;">${job.items.length} ITEMS (Enter POs):</div>`;
                            job.items.forEach((item, i) => {
                                content += `
                                <div style="margin-top:4px; display:flex; align-items:center;">
                                    <input type="text" class="po-input" id="po-${isaKey}-${idx}-${i}" value="${item.po}" placeholder="PO#">
                                    <span style="font-family: monospace; color: #ccc;">${item.isd}</span>
                                </div>`;
                            });
                        }
                        rowsHtml += `
                            <tr>
                                <td width="100">${tag}</td><td>${content}</td>
                                <td width="100" align="center"><input type="number" class="qty-input" id="qty-${isaKey}-exp-${idx}" value="${job.qty}" min="1"></td>
                                <td width="100" align="right"><button class="btn btn-print-row" onclick="printSingle('${isaKey}', 'exp', ${idx}, this)">PRINT</button></td>
                            </tr>
                        `;
                    });
                } else {
                    const job = bundle.condensedJob;
                    const tag = `<span class="tag tag-master">MASTER</span>`;
                    const content = `<span style="color:var(--accent-purple); font-weight:700;">${job.isds[0]} (Consolidated)</span>`;
                    rowsHtml += `
                        <tr>
                            <td width="100">${tag}</td><td>${content}</td>
                            <td width="100" align="center"><input type="number" class="qty-input" id="qty-${isaKey}-con-0" value="${job.qty}" min="1"></td>
                            <td width="100" align="right"><button class="btn btn-print-row" onclick="printSingle('${isaKey}', 'con', 0, this)">PRINT</button></td>
                        </tr>
                    `;
                }
                const section = document.createElement('div');
                section.className = 'isa-bundle';
                section.innerHTML = `${headerHtml}<table class="dispatch-table"><thead><tr><th>Type</th><th>Contents</th><th style="text-align:center">Qty</th><th></th></tr></thead><tbody>${rowsHtml}</tbody></table>`;
                container.appendChild(section);
            });
        }

        function markPrinted(btn) {
            if(btn) {
                if(btn.classList.contains('btn-print-all')) { btn.innerHTML = `✔ PRINTED`; } else { btn.innerText = "✔"; }
                btn.classList.add('printed');
            }
        }

        function getHeader(isaKey) {
            let h = document.getElementById(`carrier-${isaKey}`).value;
            if(!h || h.trim() === "") h = document.getElementById('fallbackHeader').value;
            return h.toUpperCase();
        }

        function printSingle(isaKey, context, idx, btn) {
            const bundle = ISA_GROUPS[isaKey];
            const headerText = getHeader(isaKey);
            let job, count;
            let isMaster = (context === 'con');

            if (context === 'exp') {
                job = bundle.jobs[idx];
                count = parseInt(document.getElementById(`qty-${isaKey}-exp-${idx}`).value) || 1;
                if(job.type === 'B') {
                    job.items.forEach((item, i) => {
                        const poVal = document.getElementById(`po-${isaKey}-${idx}-${i}`).value;
                        item.po = poVal ? poVal.toUpperCase() : "";
                    });
                }
            } else {
                job = bundle.condensedJob;
                count = parseInt(document.getElementById(`qty-${isaKey}-con-0`).value) || 1;
            }
            const zplList = generateZPLForJob(job, headerText, bundle.date, count, isMaster);
            launchPrintWindow(zplList);
            markPrinted(btn);
        }

        function printBundle(isaKey, btn) {
            const bundle = ISA_GROUPS[isaKey];
            const headerText = getHeader(isaKey);
            let masterList = [];
            if (bundle.mode === 'expanded') {
                bundle.jobs.forEach((job, idx) => {
                    const count = parseInt(document.getElementById(`qty-${isaKey}-exp-${idx}`).value) || 1;
                    if(job.type === 'B') {
                        job.items.forEach((item, i) => {
                            const poVal = document.getElementById(`po-${isaKey}-${idx}-${i}`).value;
                            item.po = poVal ? poVal.toUpperCase() : "";
                        });
                    }
                    masterList = masterList.concat(generateZPLForJob(job, headerText, bundle.date, count, false));
                });
            } else {
                const job = bundle.condensedJob;
                const count = parseInt(document.getElementById(`qty-${isaKey}-con-0`).value) || 1;
                masterList = masterList.concat(generateZPLForJob(job, headerText, bundle.date, count, true));
            }
            launchPrintWindow(masterList);
            markPrinted(btn);
        }

        function generateZPLForJob(job, header, date, totalQty, isMaster) {
            const arr = [];
            const subtitle = isMaster ? "APPOINTMENT ID" : "SHIPMENT ID";
            if (job.type === 'A') {
                for(let i=1; i<=totalQty; i++) { arr.push(generateZPL_A(header, date, job.isds[0], i, totalQty, subtitle)); }
            } else {
                for(let i=1; i<=totalQty; i++) { arr.push(generateZPL_B(header, date, job.items, i, totalQty)); }
            }
            return arr;
        }

        function generateZPL_A(header, date, barcode, current, total, subtitle) {
            let fontSize = 170;
            if (header.length > 10) fontSize = 120;
            if (header.length > 15) fontSize = 90;
            let charCount = String(barcode).length;
            let modW = 5; 
            let bcW = (11 * charCount + 35) * modW;
            if(bcW > 1150) modW = 4;
            let startX = Math.floor((1218 - ((11 * charCount + 35) * modW)) / 2);
            if(startX < 0) startX = 0;
            return `^XA^PW1218^LL1800
^FO0,50^FB1218,2,10,C,0^A0N,${fontSize},${fontSize}^FD${header}^FS
^FO0,230^FB1218,1,0,C,0^A0N,180,180^FD${date}^FS
^FO0,470^FB1218,1,0,C,0^A0N,40,40^FD${subtitle}^FS
^FO${startX},520^BY${modW},3,400^BCN,400,N,N,N^FD${barcode}^FS
^FO0,940^FB1218,1,0,C,0^A0N,80,80^FD${barcode}^FS
^FO0,1500^FB1218,1,0,C,0^A0N,180,180^FD${current} / ${total}^FS
^XZ`;
        }

        function generateZPL_B(header, date, items, current, total) {
            let fontSize = 170;
            if (header.length > 10) fontSize = 120;
            if (header.length > 15) fontSize = 90;
            let zpl = `^XA^PW1218^LL1800
^FO0,50^FB1218,2,10,C,0^A0N,${fontSize},${fontSize}^FD${header}^FS
^FO0,230^FB1218,1,0,C,0^A0N,180,180^FD${date}^FS
^FO50,450^A0N,50,50^FDPURCHASE ORDER:^FS^FO650,450^A0N,50,50^FDSHIPMENT ID:^FS`;
            let currentY = 510;
            items.forEach(item => {
                const poStr = item.po || "";
                zpl += `^FO50,${currentY}^A0N,60,60^FD${poStr}^FS`;
                zpl += `^FO650,${currentY}^A0N,60,60^FD${item.isd}^FS^FO650,${currentY+60}^BY3,3,70^BCN,70,N,N,N^FD${item.isd}^FS`;
                currentY += 200;
            });
            zpl += `^FO0,1550^FB1218,1,0,C,0^A0N,180,180^FD${current} / ${total}^FS^XZ`;
            return zpl;
        }

        function launchPrintWindow(zplList) {
            const w = 4; const h = 6;
            const urls = zplList.map(z => `http://api.labelary.com/v1/printers/12dpmm/labels/${w}x${h}/0/${encodeURIComponent(z)}`);
            const pWin = window.open('', '_blank', 'width=500,height=600');
            if(!pWin) { alert("POPUP BLOCKED. Please allow popups."); return; }
            pWin.document.open();
            pWin.document.write(`<html><head><title>PRINTING...</title><style>@page{size:101.6mm 152.4mm;margin:0}body{margin:0;padding:0;background:#000;color:#0f0;font-family:monospace;text-align:center}.label-page{width:101.6mm;height:152.4mm;page-break-after:always;overflow:hidden;position:relative}img{width:100%;height:100%;display:block;object-fit:contain}@media print{body{background:none}#log{display:none}}</style></head><body><div id="log">RENDERING...</div><div id="con"></div><script>const urls=${JSON.stringify(urls)};const con=document.getElementById('con');let loaded=0;function loadNext(i){if(i>=urls.length){document.getElementById('log').innerText="DONE. OPENING PRINTER...";setTimeout(()=>{window.print();window.close()},500);return}const div=document.createElement('div');div.className='label-page';const img=document.createElement('img');img.src=urls[i];img.onload=()=>{div.appendChild(img);con.appendChild(div);loaded++;document.getElementById('log').innerText="RENDERED "+loaded+" / "+urls.length;loadNext(i+1)};img.onerror=()=>{setTimeout(()=>loadNext(i),1000)}}loadNext(0);<\/script></body></html>`);
            pWin.document.close();
        }
    </script>
</body>
</html>